<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <div th:fragment="content">
    <form
      th:action="@{/pos}"
      th:object="${saleRequest}"
      method="post"
      id="posForm"
    >
      <input
        type="hidden"
        th:name="${_csrf.parameterName}"
        th:value="${_csrf.token}"
      />
      <div id="payMsg" style="display: none" class="alert"></div>
      <div
        th:if="${successMessage}"
        class="alert alert-success"
        th:text="${successMessage}"
      ></div>
      <div
        th:if="${errorMessage}"
        class="alert alert-danger"
        th:text="${errorMessage}"
      ></div>

      <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
        <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
      </div>

      <div class="row">
        <div class="col-lg-5">
          <div class="card shadow-sm">
            <div class="card-header">
              <h5>S·∫£n ph·∫©m (Nh·∫•n ƒë·ªÉ th√™m)</h5>
            </div>
            <div class="card-body" style="max-height: 70vh; overflow-y: auto">
              <div class="row g-3">
                <div class="col-sm-6 col-lg-6 col-xxl-4" th:each="prod : ${products}">
                  <div
                    class="card h-100"
                    th:data-id="${prod.id}"
                    th:data-name="${prod.name}"
                    th:data-price="${productDiscountedPrices != null and productDiscountedPrices.containsKey(prod.id) ? productDiscountedPrices.get(prod.id) : prod.price}"
                    th:data-stock="${prod.stockQuantity}"
                    onclick="addToCart(this.dataset.id, this.dataset.name, this.dataset.price, this.dataset.stock)"
                    style="cursor: pointer"
                  >
                    <img
                      th:if="${prod.hinhAnh}"
                      th:src="${prod.hinhAnh}"
                      alt="·∫¢nh"
                      class="card-img-top"
                      style="height: 120px; object-fit: cover"
                    />
                    <div
                      th:if="${prod.hinhAnh == null}"
                      class="card-img-top d-flex align-items-center justify-content-center text-muted"
                      style="height: 120px; background: #f1f3f5"
                    >
                      Ch∆∞a c√≥ ·∫£nh
                    </div>
                    <div class="card-body p-2 text-center">
                      <h6
                        class="card-title fs-6 mb-1"
                        th:text="${prod.name}"
                      ></h6>
                      <div
                        th:if="${productPromotions != null and productPromotions.containsKey(prod.id)}"
                        class="mb-2"
                      >
                        <span
                          class="badge bg-danger text-wrap w-100"
                          style="white-space: normal"
                          th:text="${productPromotions.get(prod.id).name + ' -' + #numbers.formatDecimal(productPromotions.get(prod.id).discountPercent, 0, 'COMMA', 0, 'POINT') + '%'}"
                        ></span>
                      </div>
                      <p class="card-text text-muted small" th:if="${productDiscountedPrices == null or !productDiscountedPrices.containsKey(prod.id)}">
                        <span th:text="${#numbers.formatDecimal(prod.price, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                      </p>
                      <p class="card-text small" th:if="${productDiscountedPrices != null and productDiscountedPrices.containsKey(prod.id)}">
                        <span class="text-decoration-line-through text-muted" th:text="${#numbers.formatDecimal(prod.price, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                        <br>
                        <span class="text-danger fw-bold" th:text="${#numbers.formatDecimal(productDiscountedPrices.get(prod.id), 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                      </p>
                      <small
                        class="text-info"
                        th:text="${'T·ªìn kho: ' + prod.stockQuantity}"
                      ></small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card shadow-sm">
            <div class="card-header">
              <h5>H√≥a ƒë∆°n thanh to√°n</h5>
            </div>
            <div class="card-body">
              <div class="mb-3 position-relative">
                <label for="memberSearch" class="form-label"
                  >G√°n cho H·ªôi vi√™n (G√µ t√™n ho·∫∑c SƒêT ƒë·ªÉ t√¨m ki·∫øm)</label
                >
                <input
                  type="text"
                  id="memberSearch"
                  class="form-control"
                  placeholder="G√µ t√™n ho·∫∑c SƒêT ƒë·ªÉ t√¨m ki·∫øm h·ªôi vi√™n..."
                  autocomplete="off"
                />
                <input type="hidden" th:field="*{memberId}" id="memberId" />
                <div
                  id="memberDropdown"
                  class="bg-white border rounded shadow"
                  style="
                    position: absolute;
                    display: none;
                    max-height: 300px;
                    overflow-y: auto;
                    z-index: 9999;
                    width: 100%;
                    top: 100%;
                    left: 0;
                    margin-top: 4px;
                  "
                ></div>
                <small class="text-muted"
                  ><i class="bi bi-info-circle"></i> G√µ t·ªëi thi·ªÉu 2 k√Ω t·ª± ƒë·ªÉ t√¨m
                  ki·∫øm. B·ªè tr·ªëng n·∫øu l√† kh√°ch v√£ng lai.</small
                >
              </div>

              <table class="table">
                <thead>
                  <tr>
                    <th>S·∫£n ph·∫©m</th>
                    <th style="width: 120px">S·ªë l∆∞·ª£ng</th>
                    <th>ƒê∆°n gi√°</th>
                    <th class="text-end">Th√†nh ti·ªÅn</th>
                  </tr>
                </thead>
                <tbody id="cart-table-body"></tbody>
                <tfoot>
                  <tr class="fw-bold fs-5">
                    <td colspan="3">T·ªîNG C·ªòNG</td>
                    <td class="text-end" id="cart-total">0 VNƒê</td>
                  </tr>
                </tfoot>
              </table>

              <div id="cart-hidden-inputs"></div>

              <div class="mt-4">
                <label class="form-label fw-bold"
                  >H√¨nh th·ª©c thanh to√°n t·∫°i qu·∫ßy:</label
                >
                <div class="d-flex gap-3">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      th:field="*{paymentMethod}"
                      id="payCash"
                      value="CASH"
                      required
                    />
                    <label class="form-check-label" for="payCash"
                      >üíµ Ti·ªÅn m·∫∑t</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      th:field="*{paymentMethod}"
                      id="payVNPay"
                      value="VN_PAY"
                      required
                    />
                    <label class="form-check-label" for="payVNPay"
                      >üí≥ VNPay (Online)</label
                    >
                  </div>
                </div>
              </div>

              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-success btn-lg">
                  THANH TO√ÅN
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <script th:inline="javascript">
      // D√πng Map ƒë·ªÉ l∆∞u gi·ªè h√†ng: (key: productId, value: {name, price, stock, quantity})
      const cart = new Map();

      // L·∫•y c√°c element DOM
      const cartTableBody = document.getElementById("cart-table-body");
      const cartTotalEl = document.getElementById("cart-total");
      const cartHiddenInputs = document.getElementById("cart-hidden-inputs");

      // H√†m Format ti·ªÅn
      const formatter = new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND",
      });

      function addToCart(id, name, price, stock) {
        const numPrice = parseFloat(price);
        const numStock = parseInt(stock);

        if (cart.has(id)) {
          // TƒÉng s·ªë l∆∞·ª£ng
          const item = cart.get(id);
          if (item.quantity < numStock) {
            item.quantity++;
          } else {
            alert("ƒê√£ ƒë·∫°t s·ªë l∆∞·ª£ng t·ªìn kho t·ªëi ƒëa!");
          }
        } else {
          // Th√™m m·ªõi
          if (numStock > 0) {
            cart.set(id, {
              name: name,
              price: numPrice,
              stock: numStock,
              quantity: 1,
            });
          } else {
            alert("S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng!");
          }
        }
        renderCart();
      }

      function changeQuantity(id, newQuantity) {
        if (!cart.has(id)) return;

        const item = cart.get(id);
        const numQuantity = parseInt(newQuantity);

        if (numQuantity <= 0) {
          // X√≥a kh·ªèi gi·ªè h√†ng
          cart.delete(id);
        } else if (numQuantity > item.stock) {
          alert("S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho!");
          // Ph·ª•c h·ªìi gi√° tr·ªã c≈©
          renderCart();
        } else {
          // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
          item.quantity = numQuantity;
        }
        renderCart();
      }

      function renderCart() {
        // X√≥a n·ªôi dung c≈©
        cartTableBody.innerHTML = "";
        cartHiddenInputs.innerHTML = "";

        let total = 0;
        let itemIndex = 0;

        if (cart.size === 0) {
          cartTableBody.innerHTML =
            '<tr><td colspan="4" class="text-center text-muted">Gi·ªè h√†ng tr·ªëng</td></tr>';
        }

        for (const [id, item] of cart.entries()) {
          const subtotal = item.price * item.quantity;
          total += subtotal;

          // 1. C·∫≠p nh·∫≠t b·∫£ng hi·ªÉn th·ªã
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm"
                               value="${item.quantity}"
                               min="0"
                               max="${item.stock}"
                               onchange="changeQuantity('${id}', this.value)">
                    </td>
                    <td>${formatter.format(item.price)}</td>
                    <td class="text-end">${formatter.format(subtotal)}</td>
                `;
          cartTableBody.appendChild(row);

          // 2. C·∫≠p nh·∫≠t c√°c input ·∫©n cho form submit
          const inputId = document.createElement("input");
          inputId.type = "hidden";
          inputId.name = `items[${itemIndex}].productId`;
          inputId.value = id;
          cartHiddenInputs.appendChild(inputId);

          const inputQty = document.createElement("input");
          inputQty.type = "hidden";
          inputQty.name = `items[${itemIndex}].quantity`;
          inputQty.value = item.quantity;
          cartHiddenInputs.appendChild(inputQty);

          itemIndex++;
        }

        // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
        cartTotalEl.innerText = formatter.format(total);
      }

      (function () {
        const p = new URLSearchParams(location.search);
        const pay = p.get("pay");
        const el = document.getElementById("payMsg");
        if (pay === "success") {
          el.className = "alert alert-success";
          el.textContent = "Thanh to√°n VNPay th√†nh c√¥ng.";
          el.style.display = "block";
        }
        if (pay === "canceled") {
          el.className = "alert alert-warning";
          el.textContent = "B·∫°n ƒë√£ h·ªßy thanh to√°n VNPay.";
          el.style.display = "block";
        }
        if (pay === "failed") {
          el.className = "alert alert-danger";
          el.textContent = "Thanh to√°n VNPay th·∫•t b·∫°i.";
          el.style.display = "block";
        }
      })();

      document.addEventListener("DOMContentLoaded", function () {
        let searchTimeout;
        const searchInput = document.getElementById("memberSearch");
        const memberIdInput = document.getElementById("memberId");
        const dropdown = document.getElementById("memberDropdown");

        function hideDropdown() {
          dropdown.style.display = "none";
        }
        function showDropdown(html) {
          dropdown.innerHTML = html;
          dropdown.style.display = "block";
        }

        searchInput.addEventListener("input", function () {
          const query = this.value.trim();
          clearTimeout(searchTimeout);
          if (query.length < 2) {
            hideDropdown();
            memberIdInput.value = "";
            return;
          }
          searchTimeout = setTimeout(async () => {
            showDropdown('<div class="p-2 text-info">ƒêang t√¨m ki·∫øm...</div>');
            try {
              const res = await fetch(
                `/api/members/search?q=${encodeURIComponent(query)}`
              );
              if (!res.ok) throw new Error("network");
              const data = await res.json();
              if (!Array.isArray(data) || data.length === 0) {
                showDropdown(
                  '<div class="p-2 text-muted">Kh√¥ng t√¨m th·∫•y h·ªôi vi√™n</div>'
                );
              } else {
                let html = "";
                data.forEach((member) => {
                  const displayPhone =
                    member.phoneNumber || member.barcode || "Ch∆∞a c√≥ SƒêT";
                  html += `<div class="member-item p-2 border-bottom" style="cursor: pointer;" data-id="${member.id}" data-name="${member.fullName}">
                            <strong>${member.fullName}</strong><br/>
                            <small class="text-muted">SƒêT: ${displayPhone}</small>
                          </div>`;
                });
                showDropdown(html);
              }
            } catch (e) {
              showDropdown(
                '<div class="p-2 text-danger">L·ªói khi t√¨m ki·∫øm</div>'
              );
            }
          }, 250);
        });

        dropdown.addEventListener("click", function (e) {
          const item = e.target.closest(".member-item");
          if (!item) return;
          const id = item.getAttribute("data-id");
          const name = item.getAttribute("data-name");
          memberIdInput.value = id;
          searchInput.value = name;
          hideDropdown();
        });

        document.addEventListener("click", function (e) {
          if (
            !e.target.closest("#memberSearch") &&
            !e.target.closest("#memberDropdown")
          ) {
            hideDropdown();
          }
        });

        dropdown.addEventListener("mouseover", function (e) {
          const item = e.target.closest(".member-item");
          if (item) item.style.backgroundColor = "#f8f9fa";
        });
        dropdown.addEventListener("mouseout", function (e) {
          const item = e.target.closest(".member-item");
          if (item) item.style.backgroundColor = "white";
        });
      });
    </script>
  </div>
</html>
