<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <div th:fragment="content">
    <div
      th:if="${successMessage}"
      class="alert alert-success"
      th:text="${successMessage}"
    ></div>
    <div
      th:if="${errorMessage}"
      class="alert alert-danger"
      th:text="${errorMessage}"
    ></div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="mb-3">
          ƒêƒÉng k√Ω g√≥i cho: <span th:text="${memberProfile.fullName}"></span>
        </h4>

        <form
          th:action="@{/members/{id}/subscribe(id=${memberProfile.id})}"
          th:object="${subRequest}"
          method="post"
        >
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />

          <div class="mb-3">
            <label class="form-label">Ch·ªçn G√≥i t·∫≠p</label>
            <select class="form-select" th:field="*{packageId}" id="packageSelect" required>
              <option value="">-- Ch·ªçn g√≥i --</option>
              <option
                th:each="pkg : ${allPackages}"
                th:value="${pkg.id}"
                th:attr="data-package-type=${pkg.packageType.name()}, data-assigned-pt-id=${pkg.assignedPtId}, data-assigned-pt-name=${pkg.assignedPtName}, data-duration-months=${pkg.durationMonths}, data-duration-days=${pkg.durationDays}, data-allowed-weekdays=${pkg.allowedWeekdays != null ? pkg.allowedWeekdays : ''}"
                th:text="${pkg.name + ' - ' + #numbers.formatDecimal(pkg.price, 0, 'COMMA', 0, 'POINT') + ' VNƒê' + (pkg.assignedPtName != null ? ' (PT: ' + pkg.assignedPtName + ')' : '')}"
              ></option>
            </select>
          </div>

          <div
            class="alert alert-info"
            id="pricePreview"
            style="display: none"
          ></div>
          <div
            class="alert alert-warning"
            id="durationPreview"
            style="display: none"
          ></div>
          <div
            class="text-end mt-2"
            id="totalPreview"
            style="display: none; font-size: 1.1rem"
          >
            <strong>T·ªîNG S·ªê TI·ªÄN: <span id="totalAmount">0 VNƒê</span></strong>
          </div>

          <div class="mb-3">
            <label class="form-label">H√¨nh th·ª©c thanh to√°n</label>
            <select class="form-select" th:field="*{paymentMethod}" required>
              <option value="CASH">üíµ Ti·ªÅn m·∫∑t</option>
              <option value="VN_PAY">üí≥ VNPay (Online)</option>
            </select>
          </div>

          <!-- Hi·ªÉn th·ªã th√¥ng tin PT n·∫øu g√≥i ƒë√£ c√≥ PT -->
          <div class="mb-3" id="ptInfoSection" style="display: none">
            <div class="alert alert-info mb-0">
              <strong>üë§ PT ƒë∆∞·ª£c g√°n:</strong> <span id="ptNameDisplay"></span>
            </div>
          </div>

          <!-- Ch·ªçn khung gi·ªù cho g√≥i PT -->
          <div class="mb-3" id="timeSlotSection" style="display: none">
            <label class="form-label">Ch·ªçn khung gi·ªù <span class="text-danger">*</span></label>
            <select class="form-select" th:field="*{timeSlot}" id="timeSlotSelect" required>
              <option value="">-- Ch·ªçn khung gi·ªù --</option>
              <option value="MORNING">S√°ng (9h - 11h)</option>
              <option value="AFTERNOON_1">Chi·ªÅu 1 (13h - 15h)</option>
              <option value="AFTERNOON_2">Chi·ªÅu 2 (16h - 18h)</option>
              <option value="EVENING">T·ªëi (19h - 21h)</option>
            </select>
            <small class="form-text text-muted" id="timeSlotHelp"></small>
          </div>

          <!-- Hi·ªÉn th·ªã c√°c th·ª© trong tu·∫ßn cho ph√©p t·∫≠p -->
          <div class="mb-3" id="allowedWeekdaysSection" style="display: none">
            <label class="form-label">C√°c th·ª© trong tu·∫ßn c√≥ th·ªÉ t·∫≠p</label>
            <div class="alert alert-info mb-0" id="allowedWeekdaysDisplay">
              <strong>üìÖ C√°c th·ª© c√≥ th·ªÉ t·∫≠p:</strong> <span id="weekdaysText">ƒêang t·∫£i...</span>
            </div>
            <small class="form-text text-muted">
              G√≥i t·∫≠p n√†y cho ph√©p t·∫≠p v√†o c√°c th·ª© ƒë√£ ch·ªçn. B·∫°n c√≥ th·ªÉ ch·ªçn l·∫°i c√°c th·ª© khi ƒëƒÉng k√Ω.
            </small>
          </div>

          <div class="d-flex justify-content-between">
            <a
              th:href="@{/members/detail/{id}(id=${memberProfile.id})}"
              class="btn btn-secondary"
              >Quay l·∫°i</a
            >
            <button type="submit" class="btn btn-primary">ƒêƒÉng k√Ω g√≥i</button>
          </div>
        </form>
      </div>
    </div>

    <script th:inline="javascript">
      const pkgSelect = document.getElementById('packageSelect');
      const preview = document.getElementById('pricePreview');
      const durationPreview = document.getElementById('durationPreview');
      const totalPreview = document.getElementById('totalPreview');
      const ptInfoSection = document.getElementById('ptInfoSection');
      const timeSlotSection = document.getElementById('timeSlotSection');
      const timeSlotSelect = document.getElementById('timeSlotSelect');
      const timeSlotHelp = document.getElementById('timeSlotHelp');
      const ptNameDisplay = document.getElementById('ptNameDisplay');
      const allowedWeekdaysSection = document.getElementById('allowedWeekdaysSection');
      const weekdaysText = document.getElementById('weekdaysText');
      
      // H√†m chuy·ªÉn ƒë·ªïi t√™n th·ª© t·ª´ ti·∫øng Anh sang ti·∫øng Vi·ªát
      function getWeekdayName(day) {
        const weekdayMap = {
          'MON': 'Th·ª© 2',
          'TUE': 'Th·ª© 3',
          'WED': 'Th·ª© 4',
          'THU': 'Th·ª© 5',
          'FRI': 'Th·ª© 6',
          'SAT': 'Th·ª© 7',
          'SUN': 'Ch·ªß nh·∫≠t'
        };
        return weekdayMap[day] || day;
      }
      
      // H√†m hi·ªÉn th·ªã c√°c th·ª© trong tu·∫ßn
      function displayAllowedWeekdays(allowedWeekdays) {
        if (!allowedWeekdays || allowedWeekdays.trim() === '') {
          allowedWeekdaysSection.style.display = 'none';
          return;
        }
        
        const weekdays = allowedWeekdays.split(',').map(w => w.trim());
        const weekdayNames = weekdays.map(getWeekdayName);
        weekdaysText.textContent = weekdayNames.join(', ');
        allowedWeekdaysSection.style.display = 'block';
      }
      
      function fmt(n){ return new Intl.NumberFormat('vi-VN').format(Number(n)) + ' VNƒê'; }
      
      function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
      
      function calculateDurationRange(durationMonths, durationDays) {
        // L·∫•y ng√†y hi·ªán t·∫°i (ng√†y ƒëƒÉng k√Ω) - d√πng ng√†y h√¥m nay
        const startDate = new Date();
        // Reset gi·ªù v·ªÅ 00:00:00 ƒë·ªÉ tr√°nh v·∫•n ƒë·ªÅ timezone
        startDate.setHours(0, 0, 0, 0);
        let endDate;
        
        if (durationMonths && durationMonths > 0) {
          // T√≠nh ng√†y k·∫øt th√∫c b·∫±ng c√°ch c·ªông s·ªë th√°ng
          endDate = new Date(startDate);
          endDate.setMonth(endDate.getMonth() + durationMonths);
          // ƒê·∫£m b·∫£o ng√†y k·∫øt th√∫c c≈©ng l√† 00:00:00
          endDate.setHours(0, 0, 0, 0);
        } else if (durationDays && durationDays > 0) {
          // T√≠nh ng√†y k·∫øt th√∫c b·∫±ng c√°ch c·ªông s·ªë ng√†y
          endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + durationDays);
          endDate.setHours(0, 0, 0, 0);
        } else {
          return null;
        }
        
        return {
          start: formatDate(startDate),
          end: formatDate(endDate)
        };
      }
      
      async function loadAvailableTimeSlots(packageId) {
        try {
          const res = await fetch(`/members/packages/${packageId}/available-time-slots`);
          const data = await res.json();
          
          // Ki·ªÉm tra n·∫øu c√≥ l·ªói
          if (!res.ok || data.error) {
            throw new Error(data.error || 'Kh√¥ng th·ªÉ t·∫£i khung gi·ªù');
          }
          
          // ƒê·∫£m b·∫£o data l√† array
          if (!Array.isArray(data)) {
            throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
          }
          
          const slots = data;
          
          // X√≥a c√°c option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
          while (timeSlotSelect.options.length > 1) {
            timeSlotSelect.remove(1);
          }
          
          // Th√™m c√°c time slot v·ªõi tr·∫°ng th√°i available/taken
          slots.forEach(slot => {
            const option = document.createElement('option');
            option.value = slot.timeSlot;
            const statusText = slot.available ? '‚úÖ C√≤n tr·ªëng' : '‚ùå ƒê√£ ƒë·∫∑t';
            option.textContent = `${slot.displayName} (${slot.startTime} - ${slot.endTime}) - ${statusText}`;
            option.disabled = !slot.available;
            if (!slot.available) {
              option.style.color = '#999';
            }
            timeSlotSelect.appendChild(option);
          });
          
          // C·∫≠p nh·∫≠t help text
          const availableCount = slots.filter(s => s.available).length;
          if (availableCount === 0) {
            timeSlotHelp.textContent = '‚ö†Ô∏è T·∫•t c·∫£ khung gi·ªù ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t. Vui l√≤ng ch·ªçn g√≥i kh√°c.';
            timeSlotHelp.className = 'form-text text-danger';
          } else {
            timeSlotHelp.textContent = `C√≥ ${availableCount} khung gi·ªù c√≤n tr·ªëng.`;
            timeSlotHelp.className = 'form-text text-muted';
          }
        } catch (e) {
          console.error('Error loading time slots:', e);
          timeSlotHelp.textContent = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin khung gi·ªù: ' + e.message;
          timeSlotHelp.className = 'form-text text-danger';
        }
      }
      
      async function refreshPreview(){
        const pkgId = pkgSelect.value;
        if(!pkgId){
          preview.style.display='none';
          durationPreview.style.display='none';
          totalPreview.style.display='none';
          ptInfoSection.style.display='none';
          timeSlotSection.style.display='none';
          return;
        }

        // L·∫•y th√¥ng tin t·ª´ option ƒë∆∞·ª£c ch·ªçn
        const selectedOption = pkgSelect.options[pkgSelect.selectedIndex];
        const packageType = selectedOption.getAttribute('data-package-type');
        const assignedPtId = selectedOption.getAttribute('data-assigned-pt-id');
        const assignedPtName = selectedOption.getAttribute('data-assigned-pt-name');
        const durationMonths = selectedOption.getAttribute('data-duration-months');
        const durationDays = selectedOption.getAttribute('data-duration-days');
        const allowedWeekdays = selectedOption.getAttribute('data-allowed-weekdays') || '';

        // X·ª≠ l√Ω hi·ªÉn th·ªã khung th·ªùi gian cho g√≥i GYM_ACCESS
        // Lu√¥n t√≠nh l·∫°i t·ª´ ng√†y hi·ªán t·∫°i khi ch·ªçn g√≥i
        if (packageType === 'GYM_ACCESS') {
          const months = durationMonths && durationMonths !== 'null' ? parseInt(durationMonths) : null;
          const days = durationDays && durationDays !== 'null' ? parseInt(durationDays) : null;
          const range = calculateDurationRange(months, days);
          
          if (range) {
            durationPreview.style.display = 'block';
            durationPreview.innerHTML = `<strong>üìÖ Th·ªùi h·∫°n g√≥i:</strong> T·ª´ ng√†y <strong>${range.start}</strong> ƒë·∫øn ng√†y <strong>${range.end}</strong>`;
          } else {
            durationPreview.style.display = 'none';
          }
        } else {
          durationPreview.style.display = 'none';
        }

        // X·ª≠ l√Ω hi·ªÉn th·ªã PT v√† time slot
        if(packageType === 'PT_SESSION') {
          if(assignedPtId && assignedPtName) {
            // G√≥i ƒë√£ c√≥ PT -> hi·ªÉn th·ªã t√™n PT v√† ch·ªçn khung gi·ªù
            ptInfoSection.style.display='block';
            ptNameDisplay.textContent = assignedPtName;
            timeSlotSection.style.display='block';
            timeSlotSelect.required = true;
            
            // Hi·ªÉn th·ªã c√°c th·ª© trong tu·∫ßn cho ph√©p t·∫≠p
            const allowedWeekdays = selectedOption.dataset.allowedWeekdays || '';
            displayAllowedWeekdays(allowedWeekdays);
            
            // Load available time slots
            await loadAvailableTimeSlots(pkgId);
          } else {
            // G√≥i ch∆∞a c√≥ PT -> ·∫©n t·∫•t c·∫£
            ptInfoSection.style.display='none';
            timeSlotSection.style.display='none';
            timeSlotSelect.required = false;
            allowedWeekdaysSection.style.display='none';
          }
        } else {
          ptInfoSection.style.display='none';
          timeSlotSection.style.display='none';
          timeSlotSelect.required = false;
          allowedWeekdaysSection.style.display='none';
        }

        try{
          const memberId = /*[[${memberProfile.id}]]*/ null;
          if (!memberId) {
            throw new Error('Kh√¥ng t√¨m th·∫•y ID h·ªôi vi√™n');
          }
          const res = await fetch(`/members/${memberId}/subscribe/preview?packageId=${pkgId}`);
          
          if (!res.ok) {
            const errorData = await res.json().catch(() => ({ error: 'L·ªói k·∫øt n·ªëi ƒë·∫øn server' }));
            throw new Error(errorData.error || `L·ªói HTTP: ${res.status}`);
          }
          
          const data = await res.json();
          
          if(data.error){
            preview.style.display='block';
            preview.className='alert alert-warning';
            preview.textContent = 'L·ªói: ' + data.error;
            totalPreview.style.display='none';
            return;
          }
          
          // Hi·ªÉn th·ªã th√¥ng tin gi√°
          preview.style.display='block';
          preview.className='alert alert-info';
          
          const promoText = data.promoPercent && parseFloat(data.promoPercent) > 0 
            ? ` ‚Äî Khuy·∫øn m√£i: <strong>${data.promoPercent}%</strong>` 
            : '';
          
          preview.innerHTML = `Gi√° g·ªëc: <strong>${fmt(data.basePrice)}</strong>${promoText} ‚Äî Gi√° cu·ªëi: <strong>${fmt(data.finalPrice)}</strong>`;
          totalPreview.style.display='block';
          document.getElementById('totalAmount').textContent = fmt(data.finalPrice);
        }catch(e){
          console.error('Error loading preview:', e);
          preview.style.display='block';
          preview.className='alert alert-warning';
          preview.textContent = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin gi·∫£m gi√°: ' + (e.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
          totalPreview.style.display='none';
        }
      }
      
      pkgSelect && pkgSelect.addEventListener('change', refreshPreview);
      refreshPreview();
    </script>
  </div>
</html>
