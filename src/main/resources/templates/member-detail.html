<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <div th:fragment="content">
    <div
      th:if="${successMessage}"
      class="alert alert-success"
      th:text="${successMessage}"
    ></div>
    <div
      th:if="${errorMessage}"
      class="alert alert-danger"
      th:text="${errorMessage}"
    ></div>

    <div class="row">
      <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title">
              H·ªôi vi√™n: <span th:text="${memberProfile.fullName}"></span>
            </h5>
            <p class="mb-1">
              <strong>SƒêT (Barcode):</strong>
              <span th:text="${memberProfile.phoneNumber}"></span>
            </p>
            <p class="mb-1">
              <strong>Email:</strong>
              <span
                th:text="${memberProfile.email != null ? memberProfile.email : 'N/A'}"
              ></span>
            </p>
            <p class="mb-1">
              <strong>Ng√†y sinh:</strong>
              <span
                th:text="${memberProfile.birthDate != null ? #temporals.format(memberProfile.birthDate, 'dd/MM/yyyy') : 'N/A'}"
              ></span>
            </p>
            <p class="mb-0">
              <strong>ƒê·ªãa ch·ªâ:</strong>
              <span
                th:text="${memberProfile.address != null ? memberProfile.address : 'N/A'}"
              ></span>
            </p>
            <hr />
            <a
              th:href="@{/members/edit/{id}(id=${memberProfile.id})}"
              class="btn btn-sm btn-outline-primary"
              >Ch·ªânh s·ª≠a th√¥ng tin</a
            >
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">Danh s√°ch g√≥i t·∫≠p</h4>
          <div>
            <button
              type="button"
              class="btn btn-outline-success"
              data-bs-toggle="modal"
              data-bs-target="#renewPackageModal"
            >
              Gia h·∫°n
            </button>
            <a
              th:href="@{/members/{id}/subscribe(id=${memberProfile.id})}"
              class="btn btn-primary"
            >
              + ƒêƒÉng k√Ω g√≥i
            </a>
          </div>
        </div>

        <div
          th:if="${memberSubscriptions == null or memberSubscriptions.isEmpty()}"
          class="alert alert-secondary"
        >
          H·ªôi vi√™n n√†y ch∆∞a ƒëƒÉng k√Ω g√≥i t·∫≠p n√†o.
        </div>

        <div class="list-group shadow-sm">
          <div
            th:each="sub : ${memberSubscriptions}"
            class="list-group-item list-group-item-action flex-column align-items-start p-3"
          >
            <div class="d-flex w-100 justify-content-between">
              <h5
                class="mb-1"
                th:text="${sub.packageName != null ? sub.packageName : 'G√≥i t·∫≠p'}"
              ></h5>
              <span
                th:if="${sub.status != null}"
                th:text="${sub.status.name() == 'ACTIVE' ? 'Ho·∫°t ƒë·ªông' : (sub.status.name() == 'FROZEN' ? 'ƒêang ƒë√≥ng bƒÉng' : (sub.status.name() == 'PENDING' ? 'Ch·ªù thanh to√°n' : (sub.status.name() == 'EXPIRED' ? 'ƒê√£ h·∫øt h·∫°n' : 'ƒê√£ h·ªßy')))}"
                th:classappend="${sub.status.name() == 'ACTIVE' ? 'badge bg-success' : (sub.status.name() == 'FROZEN' ? 'badge bg-info text-dark' : (sub.status.name() == 'PENDING' ? 'badge bg-warning text-dark' : (sub.status.name() == 'EXPIRED' ? 'badge bg-secondary' : 'badge bg-danger')))}"
                class="badge rounded-pill align-self-start"
              ></span>
            </div>

            <div class="row">
              <div
                class="col-md-6"
                th:if="${sub != null and sub.startDate != null}"
              >
                <p class="mb-1">
                  T·ª´:
                  <strong
                    th:text="${#temporals.format(sub.startDate, 'dd/MM/yyyy')}"
                  ></strong>
                </p>
                <p class="mb-1">
                  ƒê·∫øn:
                  <strong
                    th:text="${#temporals.format(sub.endDate, 'dd/MM/yyyy')}"
                  ></strong>
                </p>
                <p
                  class="mb-1"
                  th:if="${#strings.contains(sub.packageName, 'Per-Visit')}"
                >
                  S·ªë l∆∞·ª£t c√≤n l·∫°i:
                  <strong th:text="${sub.remainingSessions}"></strong>
                </p>
              </div>
              <div
                class="col-md-6"
                th:if="${sub.packageName != null and #strings.contains(sub.packageName, 'PT')}"
              >
                <p class="mb-1" th:if="${sub.remainingSessions != null}">
                  S·ªë bu·ªïi c√≤n l·∫°i:
                  <strong th:text="${sub.remainingSessions}"></strong>
                </p>
                <p class="mb-1">
                  PT Ph·ª• tr√°ch:
                  <strong
                    th:text="${sub.ptFullName != null ? sub.ptFullName : 'Ch∆∞a g√°n'}"
                  ></strong>
                </p>
              </div>
            </div>

            <div class="mt-2">
              <button
                th:if="${sub.status != null and sub.status.name() == 'ACTIVE'}"
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-bs-toggle="modal"
                data-bs-target="#freezeModal"
                th:attr="data-bs-subid=${sub.subscriptionId}, data-bs-subname=${sub.packageName}"
              >
                ƒê√≥ng bƒÉng
              </button>

              <button
                th:if="${sub.status != null and sub.status.name() == 'ACTIVE'}"
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#upgradeModal"
                th:attr="data-bs-subid=${sub.subscriptionId}, 
                        data-bs-subname=${sub.packageName},
                        data-bs-packageid=${sub.packageId},
                        data-bs-currentprice=${sub.price},
                        data-bs-packagetype=${sub.packageType != null ? sub.packageType.name() : ''},
                        data-bs-remainingsessions=${sub.remainingSessions != null ? sub.remainingSessions : 0},
                        data-bs-totalsessions=${sub.packageTotalSessions != null ? sub.packageTotalSessions : 0},
                        data-bs-startdate=${sub.startDate != null ? #temporals.format(sub.startDate, 'yyyy-MM-dd''T''HH:mm:ssXXX') : ''},
                        data-bs-enddate=${sub.endDate != null ? #temporals.format(sub.endDate, 'yyyy-MM-dd''T''HH:mm:ssXXX') : ''}"
              >
                N√¢ng c·∫•p
              </button>

              <button
                th:if="${sub.status != null and sub.status.name() == 'ACTIVE'}"
                type="button"
                class="btn btn-sm btn-outline-dark"
                data-bs-toggle="modal"
                data-bs-target="#transferModal"
                th:attr="data-bs-subid=${sub.subscriptionId}, data-bs-subname=${sub.packageName}"
              >
                Chuy·ªÉn nh∆∞·ª£ng
              </button>

              <form
                th:if="${sub.status != null and sub.status.name() == 'FROZEN'}"
                th:action="@{/members/subscription/unfreeze/{subId}(subId=${sub.subscriptionId})}"
                method="post"
                class="d-inline"
              >
                <input
                  type="hidden"
                  th:name="${_csrf.parameterName}"
                  th:value="${_csrf.token}"
                />
                <input
                  type="hidden"
                  name="memberId"
                  th:value="${memberProfile.id}"
                />
                <button type="submit" class="btn btn-sm btn-outline-success">
                  M·ªü bƒÉng
                </button>
              </form>

              <form
                th:if="${sub.status != null and sub.status.name() == 'ACTIVE'}"
                th:action="@{/members/subscription/cancel/{subId}(subId=${sub.subscriptionId})}"
                method="post"
                class="d-inline"
              >
                <input
                  type="hidden"
                  th:name="${_csrf.parameterName}"
                  th:value="${_csrf.token}"
                />
                <input
                  type="hidden"
                  name="memberId"
                  th:value="${memberProfile.id}"
                />
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#cancelModal"
                  th:attr="data-subid=${sub.subscriptionId},
                          data-member=${memberProfile.id},
                          data-subname=${sub.packageName},
                          data-packagetype=${sub.packageType},
                          data-startdate=${sub.startDate != null ? #temporals.format(sub.startDate, 'yyyy-MM-dd''T''HH:mm:ssXXX') : ''},
                          data-enddate=${sub.endDate != null ? #temporals.format(sub.endDate, 'yyyy-MM-dd''T''HH:mm:ssXXX') : ''},
                          data-remainingsessions=${sub.remainingSessions},
                          data-totalsessions=${sub.packageTotalSessions},
                          data-durationdays=${sub.packageDurationDays},
                          data-price=${sub.price}"
                >
                  H·ªßy
                </button>
              </form>
              <!-- Check-out n√∫t ƒë√£ b·ªè theo y√™u c·∫ßu -->
            </div>
          </div>
        </div>

        <!-- L·ªãch s·ª≠ t·∫≠p -->
        <div class="mt-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">üìä L·ªãch s·ª≠ t·∫≠p</h4>
          </div>
          <div class="card shadow-sm">
            <div class="card-body">
              <div
                th:if="${checkInLogs == null or checkInLogs.isEmpty()}"
                class="alert alert-secondary mb-0"
              >
                H·ªôi vi√™n n√†y ch∆∞a c√≥ l·ªãch s·ª≠ check-in/check-out.
              </div>
              <div class="table-responsive" th:if="${checkInLogs != null and !checkInLogs.isEmpty()}">
                <table class="table table-sm table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>STT</th>
                      <th>G√≥i t·∫≠p</th>
                      <th>Th·ªùi gian v√†o</th>
                      <th>Th·ªùi gian ra</th>
                      <th>Th·ªùi gian t·∫≠p</th>
                      <th>S·ªë bu·ªïi c√≤n l·∫°i</th>
                      <th>Tr·∫°ng th√°i</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="log, iterStat : ${checkInLogs}" th:classappend="${!log.isCheckedOut} ? 'table-warning' : ''">
                      <td th:text="${iterStat.index + 1}"></td>
                      <td>
                        <span th:if="${log.packageName}" 
                              th:text="${log.packageName}" 
                              class="badge bg-info"></span>
                        <span th:unless="${log.packageName}" class="text-muted">--</span>
                      </td>
                      <td>
                        <span th:if="${log.checkInTime}" 
                              th:text="${#temporals.format(log.checkInTime, 'dd/MM/yyyy HH:mm:ss')}"></span>
                        <span th:unless="${log.checkInTime}" class="text-muted">--</span>
                      </td>
                      <td>
                        <span th:if="${log.checkOutTime}" 
                              th:text="${#temporals.format(log.checkOutTime, 'dd/MM/yyyy HH:mm:ss')}"
                              class="text-success"></span>
                        <span th:unless="${log.checkOutTime}" class="text-warning">
                          <i class="bi bi-clock"></i> ƒêang t·∫≠p
                        </span>
                      </td>
                      <td>
                        <span th:if="${log.sessionDurationSeconds != null and log.sessionDurationSeconds > 0}">
                          <span th:if="${log.sessionDurationSeconds >= 3600}">
                            <span th:text="${#numbers.formatDecimal(log.sessionDurationSeconds / 3600, 0, 'POINT', 0, 'POINT')}"></span> gi·ªù
                            <span th:text="${#numbers.formatDecimal((log.sessionDurationSeconds % 3600) / 60, 0, 'POINT', 0, 'POINT')}"></span> ph√∫t
                          </span>
                          <span th:unless="${log.sessionDurationSeconds >= 3600}">
                            <span th:text="${#numbers.formatDecimal(log.sessionDurationSeconds / 60, 0, 'POINT', 0, 'POINT')}"></span> ph√∫t
                          </span>
                        </span>
                        <span th:unless="${log.sessionDurationSeconds != null and log.sessionDurationSeconds > 0}" 
                              class="text-muted">--</span>
                      </td>
                      <td>
                        <span th:if="${log.remainingSessionsAtCheckIn != null and (log.packageType?.name() == 'PT_SESSION' or log.packageType?.name() == 'PER_VISIT')}" 
                              class="badge bg-primary"
                              th:text="${log.remainingSessionsAtCheckIn} + ' bu·ªïi'"></span>
                        <span th:unless="${log.remainingSessionsAtCheckIn != null and (log.packageType?.name() == 'PT_SESSION' or log.packageType?.name() == 'PER_VISIT')}" 
                              class="text-muted">--</span>
                      </td>
                      <td>
                        <span th:switch="${log.status?.name()}">
                          <span th:case="'SUCCESS'" class="badge bg-success">Th√†nh c√¥ng</span>
                          <span th:case="'FAILED_MEMBER_NOT_FOUND'" class="badge bg-danger">L·ªói</span>
                          <span th:case="'FAILED_NO_ACTIVE_PACKAGE'" class="badge bg-warning">Kh√¥ng c√≥ g√≥i</span>
                          <span th:case="'FAILED_OFF_PEAK_TIME'" class="badge bg-info">Ngo√†i gi·ªù</span>
                          <span th:case="*" class="badge bg-secondary" th:text="${log.status?.name()}"></span>
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Link ƒë·∫øn l·ªãch s·ª≠ thanh to√°n -->
        <div class="mt-4">
          <a
            th:href="@{/members/detail/{id}/transactions(id=${memberProfile.id})}"
            class="btn btn-outline-primary"
          >
            <i class="bi bi-receipt"></i> Xem l·ªãch s·ª≠ thanh to√°n
          </a>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addPackageModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form
            th:action="@{/members/subscription/create}"
            th:object="${subRequest}"
            method="post"
          >
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <div class="modal-header">
              <h5 class="modal-title">Th√™m g√≥i t·∫≠p m·ªõi</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input type="hidden" th:field="*{memberId}" />

              <div
                th:if="${#fields.hasErrors('subRequest.*')}"
                class="alert alert-danger"
              >
                <p
                  th:each="err : ${#fields.errors('subRequest.*')}"
                  th:text="${err}"
                ></p>
              </div>

              <div class="mb-3">
                <label for="addPackageId" class="form-label"
                  >Ch·ªçn G√≥i t·∫≠p</label
                >
                <select
                  th:field="*{packageId}"
                  id="addPackageId"
                  class="form-select"
                  onchange="updatePackagePrice('add', this)"
                  required
                >
                  <option value="">-- Ch·ªçn g√≥i --</option>
                  <option
                    th:each="pkg : ${allPackages}"
                    th:value="${pkg.id}"
                    th:text="${pkg.name}"
                    th:attr="data-type=${pkg.packageType.name()}, data-price=${pkg.price}, data-duration=${pkg.durationDays}, data-allowed-weekdays=${pkg.allowedWeekdays != null ? pkg.allowedWeekdays : ''}"
                  ></option>
                </select>
              </div>

              <!-- Th√¥ng tin gi√° -->
              <div
                id="addPriceInfo"
                class="alert alert-info"
                style="display: none"
              >
                <h6 class="mb-2">üìã Th√¥ng tin gi√°:</h6>
                <div class="d-flex justify-content-between mb-1">
                  <span>Gi√° g·ªëc:</span>
                  <span id="addOriginalPrice" class="fw-bold">0 VNƒê</span>
                </div>
                <div id="addDiscountInfo" style="display: none">
                  <div class="d-flex justify-content-between mb-1 text-success">
                    <span>üéÅ Gi·∫£m gi√°:</span>
                    <span id="addDiscountAmount" class="fw-bold">- 0 VNƒê</span>
                  </div>
                  <div class="d-flex justify-content-between mb-1">
                    <span
                      id="addDiscountReason"
                      class="small text-muted"
                    ></span>
                  </div>
                </div>
                <hr class="my-2" />
                <div class="d-flex justify-content-between">
                  <span class="fw-bold">T·ªïng thanh to√°n:</span>
                  <span id="addFinalPrice" class="fw-bold text-primary fs-5"
                    >0 VNƒê</span
                  >
                </div>
              </div>

              <div class="mb-3" id="addPtSelectWrapper" style="display: none">
                <label for="addAssignedPtId" class="form-label"
                  >G√°n cho PT (T√πy ch·ªçn)</label
                >
                <select
                  th:field="*{assignedPtId}"
                  id="addAssignedPtId"
                  class="form-select"
                >
                  <option value="">-- Kh√¥ng g√°n --</option>
                  <option
                    th:each="pt : ${allPts}"
                    th:value="${pt.id}"
                    th:text="${pt.fullName}"
                  ></option>
                </select>
              </div>

              <!-- Ch·ªçn c√°c th·ª© trong tu·∫ßn (ch·ªâ hi·ªÉn th·ªã khi ch·ªçn g√≥i PT_SESSION) -->
              <div class="mb-3" id="addWeekdaysWrapper" style="display: none">
                <label class="form-label">Ch·ªçn c√°c th·ª© trong tu·∫ßn cho ph√©p t·∫≠p</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input add-weekday-checkbox" type="checkbox" value="MON" id="add-weekday-mon">
                  <label class="form-check-label" for="add-weekday-mon">Th·ª© 2</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input add-weekday-checkbox" type="checkbox" value="TUE" id="add-weekday-tue">
                  <label class="form-check-label" for="add-weekday-tue">Th·ª© 3</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input add-weekday-checkbox" type="checkbox" value="WED" id="add-weekday-wed">
                  <label class="form-check-label" for="add-weekday-wed">Th·ª© 4</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input add-weekday-checkbox" type="checkbox" value="THU" id="add-weekday-thu">
                  <label class="form-check-label" for="add-weekday-thu">Th·ª© 5</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input add-weekday-checkbox" type="checkbox" value="FRI" id="add-weekday-fri">
                  <label class="form-check-label" for="add-weekday-fri">Th·ª© 6</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input add-weekday-checkbox" type="checkbox" value="SAT" id="add-weekday-sat">
                  <label class="form-check-label" for="add-weekday-sat">Th·ª© 7</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input add-weekday-checkbox" type="checkbox" value="SUN" id="add-weekday-sun">
                  <label class="form-check-label" for="add-weekday-sun">Ch·ªß nh·∫≠t</label>
                </div>
                <input type="hidden" th:field="*{allowedWeekdays}" id="addAllowedWeekdays" />
                <small class="form-text text-muted d-block mt-2">
                  Ch·ªçn c√°c th·ª© trong tu·∫ßn m√† b·∫°n mu·ªën t·∫≠p. N·∫øu g√≥i ƒë√£ c√≥ c√°c th·ª© m·∫∑c ƒë·ªãnh, ch√∫ng s·∫Ω ƒë∆∞·ª£c ch·ªçn s·∫µn.
                </small>
              </div>

              <div class="mb-3">
                <label class="form-label">H√¨nh th·ª©c thanh to√°n</label>
                <select
                  th:field="*{paymentMethod}"
                  class="form-select"
                  required
                >
                  <option value="CASH">üíµ Ti·ªÅn m·∫∑t</option>
                  <option value="VN_PAY">üí≥ VNPay (Online)</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
              <button type="submit" class="btn btn-primary">
                Th√™m g√≥i t·∫≠p
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="renewPackageModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form
            th:action="@{/members/subscription/renew}"
            th:object="${subRequest}"
            method="post"
          >
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <div class="modal-header">
              <h5 class="modal-title">Gia h·∫°n g√≥i t·∫≠p</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input type="hidden" th:field="*{memberId}" />

              <div class="mb-3">
                <label for="renewPackageId" class="form-label"
                  >Ch·ªçn G√≥i t·∫≠p ƒë·ªÉ gia h·∫°n</label
                >
                <select
                  th:field="*{packageId}"
                  id="renewPackageId"
                  class="form-select"
                  onchange="updatePackagePrice('renew', this)"
                  required
                >
                  <option value="">-- Ch·ªçn g√≥i --</option>
                  <option
                    th:each="pkg : ${renewPackages}"
                    th:value="${pkg.id}"
                    th:text="${pkg.name}"
                    th:attr="data-type=${pkg.packageType.name()}, data-price=${pkg.price}, data-duration=${pkg.durationDays}"
                  ></option>
                </select>
                <div th:if="${renewPackages == null or renewPackages.isEmpty()}" class="alert alert-warning mt-2 mb-0">
                  <small>B·∫°n ch∆∞a c√≥ g√≥i t·∫≠p ƒëang ho·∫°t ƒë·ªông ƒë·ªÉ gia h·∫°n.</small>
                </div>
              </div>

              <!-- Th√¥ng tin gi√° -->
              <div
                id="renewPriceInfo"
                class="alert alert-info"
                style="display: none"
              >
                <h6 class="mb-2">üìã Th√¥ng tin gi√°:</h6>
                <div class="d-flex justify-content-between mb-1">
                  <span>Gi√° g·ªëc:</span>
                  <span id="renewOriginalPrice" class="fw-bold">0 VNƒê</span>
                </div>
                <div id="renewDiscountInfo" style="display: none">
                  <div class="d-flex justify-content-between mb-1 text-success">
                    <span>üéÅ Gi·∫£m gi√°:</span>
                    <span id="renewDiscountAmount" class="fw-bold"
                      >- 0 VNƒê</span
                    >
                  </div>
                  <div class="d-flex justify-content-between mb-1">
                    <span
                      id="renewDiscountReason"
                      class="small text-muted"
                    ></span>
                  </div>
                </div>
                <hr class="my-2" />
                <div class="d-flex justify-content-between">
                  <span class="fw-bold">T·ªïng thanh to√°n:</span>
                  <span id="renewFinalPrice" class="fw-bold text-primary fs-5"
                    >0 VNƒê</span
                  >
                </div>
              </div>

              <div class="mb-3" id="renewPtSelectWrapper" style="display: none">
                <label for="renewAssignedPtId" class="form-label"
                  >G√°n cho PT (T√πy ch·ªçn)</label
                >
                <select
                  th:field="*{assignedPtId}"
                  id="renewAssignedPtId"
                  class="form-select"
                >
                  <option value="">-- Kh√¥ng g√°n --</option>
                  <option
                    th:each="pt : ${allPts}"
                    th:value="${pt.id}"
                    th:text="${pt.fullName}"
                  ></option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">H√¨nh th·ª©c thanh to√°n</label>
                <select
                  th:field="*{paymentMethod}"
                  class="form-select"
                  required
                >
                  <option value="CASH">üíµ Ti·ªÅn m·∫∑t</option>
                  <option value="VN_PAY">üí≥ VNPay (Online)</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
              <button type="submit" class="btn btn-success">Gia h·∫°n</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="freezeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="freezeForm" th:object="${freezeRequest}" method="post">
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <div class="modal-header">
              <h5 class="modal-title">ƒê√≥ng bƒÉng g√≥i t·∫≠p</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input
                type="hidden"
                name="memberId"
                th:value="${memberProfile.id}"
              />
              <p>
                B·∫°n mu·ªën ƒë√≥ng bƒÉng g√≥i: <strong id="freezePackageName"></strong>
              </p>

              <div class="mb-3">
                <label for="freezeDays" class="form-label"
                  >S·ªë ng√†y ƒë√≥ng bƒÉng</label
                >
                <input
                  type="number"
                  th:field="*{freezeDays}"
                  id="freezeDays"
                  class="form-control"
                  required
                  min="1"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
              <button type="submit" class="btn btn-warning">
                X√°c nh·∫≠n ƒê√≥ng bƒÉng
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="upgradeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form
            id="upgradeForm"
            method="post"
            th:action="@{/members/subscription/upgrade/0}"
          >
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <div class="modal-header">
              <h5 class="modal-title">
                N√¢ng c·∫•p g√≥i t·∫≠p: <span id="upgradePackageName"></span>
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input
                type="hidden"
                name="memberId"
                th:value="${memberProfile.id}"
              />

              <div class="alert alert-info">
                <strong>G√≥i hi·ªán t·∫°i:</strong>
                <span id="currentPackageInfo"></span><br />
                <strong id="remainingLabel">Th·ªùi gian c√≤n l·∫°i:</strong>
                <span id="remainingTime"></span>
                <span id="remainingUnit">ng√†y</span>
              </div>

              <div class="mb-3">
                <label class="form-label"
                  >Ch·ªçn g√≥i m·ªõi (ph·∫£i ƒë·∫Øt h∆°n g√≥i hi·ªán t·∫°i)</label
                >
                <select
                  class="form-select"
                  id="upgradeNewPackageSelect"
                  name="newPackageId"
                  required
                >
                  <option value="">-- Ch·ªçn g√≥i --</option>
                  <option
                    th:each="pkg : ${allPackages}"
                    th:value="${pkg.id}"
                    th:text="${pkg.name + ' - ' + #numbers.formatDecimal(pkg.price, 0, 'COMMA', 0, 'POINT') + ' VNƒê'}"
                    th:attr="data-price=${pkg.price}, data-duration=${pkg.durationDays}"
                  ></option>
                </select>
              </div>

              <div
                id="upgradePriceInfo"
                class="alert alert-success"
                style="display: none"
              >
                <h6>T√≠nh to√°n chi ph√≠:</h6>
                <div>
                  <strong>Gi√° g√≥i m·ªõi:</strong>
                  <span id="newPackagePrice"></span> VNƒê
                </div>
                <div class="text-success">
                  <strong>Gi√° tr·ªã ho√†n l·∫°i:</strong> -
                  <span id="refundValue"></span> VNƒê
                </div>
                <hr />
                <div class="fs-5">
                  <strong>Ph·∫£i tr·∫£ th√™m:</strong>
                  <span id="finalUpgradePrice" class="text-danger"></span> VNƒê
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">H√¨nh th·ª©c thanh to√°n</label>
                <select class="form-select" name="paymentMethod" required>
                  <option value="CASH">üíµ Ti·ªÅn m·∫∑t</option>
                  <option value="VN_PAY">üí≥ VNPay (Online)</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
              <button type="submit" class="btn btn-primary">N√¢ng c·∫•p</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="transferModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="transferForm" method="post">
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <div class="modal-header">
              <h5 class="modal-title">
                Chuy·ªÉn nh∆∞·ª£ng g√≥i: <span id="transferPackageName"></span>
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input
                type="hidden"
                name="memberId"
                th:value="${memberProfile.id}"
              />
              <div class="mb-3">
                <label class="form-label">Ch·ªçn h·ªôi vi√™n nh·∫≠n</label>
                <select class="form-select" name="toMemberId" required>
                  <option value="">-- Ch·ªçn h·ªôi vi√™n --</option>
                  <option
                    th:each="m : ${allMembers}"
                    th:value="${m.id}"
                    th:text="${m.fullName} + ' (' + m.phoneNumber + ')'"
                    th:disabled="${m.id == memberProfile.id}"
                  ></option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
              <button type="submit" class="btn btn-dark">Chuy·ªÉn nh∆∞·ª£ng</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      /* L·∫•y URL g·ªëc (ƒë·ªÉ t·∫°o action cho form) */
      const baseUrl = /*[[@{/members/subscription}]]*/ "/members/subscription";

      // Th√¥ng tin member ƒë·ªÉ t√≠nh gi·∫£m gi√°
      const hasExistingPackages = /*[[${memberSubscriptions == null ? false : !memberSubscriptions.isEmpty()}]]*/ false;

      // H√†m format s·ªë ti·ªÅn
      function formatMoney(amount) {
        return new Intl.NumberFormat("vi-VN").format(amount) + " VNƒê";
      }

      // H√†m t√≠nh gi√° v·ªõi gi·∫£m gi√°
      function calculateDiscountedPrice(
        originalPrice,
        durationDays,
        isReturningCustomer
      ) {
        let finalPrice = originalPrice;
        let discountPercent = 0;
        let discountReason = "";

        // Logic gi·∫£m gi√° (gi·ªëng SubscriptionService.java)
        if (durationDays >= 365) {
          // G√≥i nƒÉm - gi·∫£m 20%
          finalPrice = originalPrice * 0.8;
          discountPercent = 20;
          discountReason = "‚ú® G√≥i theo nƒÉm (‚â•365 ng√†y)";
        } else if (isReturningCustomer) {
          // H·ªçc vi√™n c≈© - gi·∫£m 10%
          finalPrice = originalPrice * 0.9;
          discountPercent = 10;
          discountReason = "üíé H·ªçc vi√™n th√¢n thi·∫øt";
        }

        return {
          finalPrice: finalPrice,
          discountAmount: originalPrice - finalPrice,
          discountPercent: discountPercent,
          discountReason: discountReason,
        };
      }

      // H√†m c·∫≠p nh·∫≠t th√¥ng tin gi√° khi ch·ªçn g√≥i
      async function updatePackagePrice(prefix, selectElement) {
        const selectedOption =
          selectElement.options[selectElement.selectedIndex];
        const priceInfo = document.getElementById(prefix + "PriceInfo");
        const originalPriceEl = document.getElementById(
          prefix + "OriginalPrice"
        );
        const discountInfoEl = document.getElementById(prefix + "DiscountInfo");
        const discountAmountEl = document.getElementById(
          prefix + "DiscountAmount"
        );
        const discountReasonEl = document.getElementById(
          prefix + "DiscountReason"
        );
        const finalPriceEl = document.getElementById(prefix + "FinalPrice");

        if (!selectedOption.value) {
          priceInfo.style.display = "none";
          return;
        }

        const packageId = selectedOption.value;
        const originalPrice = parseFloat(selectedOption.dataset.price);
        const durationDays = parseInt(selectedOption.dataset.duration);
        const packageType = selectedOption.dataset.type;

        // Ki·ªÉm tra xem c√≥ ph·∫£i h·ªçc vi√™n c≈© kh√¥ng
        const isReturningCustomer = hasExistingPackages;

        // T·∫¶NG 1: T√≠nh gi√° v·ªõi gi·∫£m t·ª± ƒë·ªông
        const result = calculateDiscountedPrice(
          originalPrice,
          durationDays,
          isReturningCustomer
        );

        let finalPrice = result.finalPrice;
        let totalDiscount = result.discountAmount;
        let discountDetails = [];

        // Th√™m l√Ω do gi·∫£m t·ª± ƒë·ªông
        if (result.discountAmount > 0) {
          discountDetails.push(
            result.discountReason + " (-" + result.discountPercent + "%)"
          );
        }

        // T·∫¶NG 2: Ki·ªÉm tra Promotion t·ª´ server
        try {
          const response = await fetch(`/api/packages/${packageId}/promotion`);
          if (response.ok) {
            const promoData = await response.json();

            if (promoData.hasPromotion) {
              // T√≠nh gi·∫£m th√™m t·ª´ promotion
              const promoPercent = parseFloat(promoData.discountPercent);
              const promoDiscount = finalPrice * (promoPercent / 100);
              finalPrice = finalPrice - promoDiscount;
              totalDiscount += promoDiscount;

              discountDetails.push(`üéâ ${promoData.name} (-${promoPercent}%)`);
            }
          }
        } catch (error) {
          console.error("L·ªói khi l·∫•y th√¥ng tin promotion:", error);
        }

        // Hi·ªÉn th·ªã th√¥ng tin
        originalPriceEl.textContent = formatMoney(originalPrice);
        finalPriceEl.textContent = formatMoney(finalPrice);

        if (totalDiscount > 0) {
          discountInfoEl.style.display = "block";
          discountAmountEl.textContent = "- " + formatMoney(totalDiscount);
          discountReasonEl.innerHTML = discountDetails.join("<br>");
        } else {
          discountInfoEl.style.display = "none";
        }

        priceInfo.style.display = "block";

        // V·∫´n g·ªçi togglePtSelect ƒë·ªÉ hi·ªÉn th·ªã PT select n·∫øu c·∫ßn
        togglePtSelect(prefix, packageId);
        
        // Hi·ªÉn th·ªã/·∫©n v√† load c√°c th·ª© trong tu·∫ßn
        toggleWeekdaysSelect(prefix, packageId);
      }

      // Hi·ªÉn th·ªã/·∫©n v√† load c√°c th·ª© trong tu·∫ßn t·ª´ g√≥i
      function toggleWeekdaysSelect(prefix, selectedPackageId) {
        const selectEl = document.getElementById(prefix + "PackageId");
        const weekdaysWrapper = document.getElementById(prefix + "WeekdaysWrapper");
        const hiddenInput = document.getElementById(prefix + "AllowedWeekdays");

        if (!selectEl || !weekdaysWrapper) return;

        const selectedOption = selectEl.querySelector(
          'option[value="' + selectedPackageId + '"]'
        );
        
        if (!selectedOption) {
          weekdaysWrapper.style.display = "none";
          return;
        }

        const packageType = selectedOption.dataset.type;
        
        if (packageType === "PT_SESSION") {
          weekdaysWrapper.style.display = "block";
          
          // Load c√°c th·ª© t·ª´ g√≥i (n·∫øu c√≥)
          const allowedWeekdays = selectedOption.dataset.allowedWeekdays || "";
          if (allowedWeekdays) {
            const weekdays = allowedWeekdays.split(',').map(w => w.trim());
            // Uncheck t·∫•t c·∫£ tr∆∞·ªõc
            weekdaysWrapper.querySelectorAll('.add-weekday-checkbox').forEach(cb => {
              cb.checked = false;
            });
            // Check c√°c th·ª© t·ª´ g√≥i
            weekdays.forEach(day => {
              const checkbox = weekdaysWrapper.querySelector('#add-weekday-' + day.toLowerCase());
              if (checkbox) {
                checkbox.checked = true;
              }
            });
            // C·∫≠p nh·∫≠t hidden field
            if (hiddenInput) {
              hiddenInput.value = allowedWeekdays;
            }
          } else {
            // N·∫øu g√≥i kh√¥ng c√≥ th·ª© m·∫∑c ƒë·ªãnh, uncheck t·∫•t c·∫£
            weekdaysWrapper.querySelectorAll('.add-weekday-checkbox').forEach(cb => {
              cb.checked = false;
            });
            if (hiddenInput) {
              hiddenInput.value = "";
            }
          }
        } else {
          weekdaysWrapper.style.display = "none";
          if (hiddenInput) {
            hiddenInput.value = "";
          }
        }
      }

      // C·∫≠p nh·∫≠t hidden field allowedWeekdays khi checkbox thay ƒë·ªïi
      function updateAllowedWeekdays(prefix) {
        const wrapper = document.getElementById(prefix + "WeekdaysWrapper");
        const hiddenInput = document.getElementById(prefix + "AllowedWeekdays");
        if (!wrapper || !hiddenInput) return;
        
        const checkboxes = wrapper.querySelectorAll('.add-weekday-checkbox:checked');
        const values = Array.from(checkboxes).map(cb => cb.value);
        hiddenInput.value = values.join(',');
      }

      // 1. Script ·∫©n/hi·ªán ch·ªçn PT
      function togglePtSelect(prefix, selectedPackageId) {
        const selectEl = document.getElementById(prefix + "PackageId");
        const ptWrapper = document.getElementById(prefix + "PtSelectWrapper");

        if (!selectEl || !ptWrapper) return;

        const selectedOption = selectEl.querySelector(
          'option[value="' + selectedPackageId + '"]'
        );
        if (selectedOption) {
          const type = selectedOption.dataset.type;
          if (type === "PT_SESSION") {
            ptWrapper.style.display = "block";
          } else {
            ptWrapper.style.display = "none";
          }
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Th√™m event listener cho c√°c checkbox th·ª©
        document.querySelectorAll('.add-weekday-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            updateAllowedWeekdays('add');
          });
        });

        // 2. Script set Action cho Form ƒê√≥ng bƒÉng
        const freezeModal = document.getElementById("freezeModal");
        if (freezeModal) {
          freezeModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget; // N√∫t ƒë√£ b·∫•m
            const subId = button.getAttribute("data-bs-subid");
            const subName = button.getAttribute("data-bs-subname");

            const modalTitle = freezeModal.querySelector("#freezePackageName");
            const modalForm = freezeModal.querySelector("#freezeForm");

            modalTitle.textContent = subName;
            modalForm.action = baseUrl + "/freeze/" + subId;
          });
        }

        // 3. Script cho Modal N√¢ng c·∫•p v·ªõi t√≠nh to√°n gi√° real-time
        const upgradeModal = document.getElementById("upgradeModal");
        if (upgradeModal) {
          let currentPackageData = {};

          upgradeModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const subId = button.getAttribute("data-bs-subid");
            const subName = button.getAttribute("data-bs-subname");
            const currentPrice = parseFloat(
              button.getAttribute("data-bs-currentprice")
            );
            const packageType = button.getAttribute("data-bs-packagetype");
            const remainingSessions = parseInt(
              button.getAttribute("data-bs-remainingsessions") || "0"
            );
            const totalSessions = parseInt(
              button.getAttribute("data-bs-totalsessions") || "0"
            );
            const startDateStr = button.getAttribute("data-bs-startdate");
            const endDateStr = button.getAttribute("data-bs-enddate");
            const startDate = startDateStr ? new Date(startDateStr) : null;
            const endDate = endDateStr ? new Date(endDateStr) : null;

            // L∆∞u data g√≥i hi·ªán t·∫°i
            currentPackageData = {
              price: currentPrice,
              packageType: packageType,
              remainingSessions: remainingSessions,
              totalSessions: totalSessions,
              startDate: startDate,
              endDate: endDate,
            };

            // Hi·ªÉn th·ªã th√¥ng tin g√≥i hi·ªán t·∫°i
            upgradeModal.querySelector("#upgradePackageName").textContent =
              subName;
            upgradeModal.querySelector(
              "#currentPackageInfo"
            ).textContent = `${subName} - ${currentPrice.toLocaleString(
              "vi-VN"
            )} VNƒê`;

            // X·ª≠ l√Ω theo lo·∫°i g√≥i
            const remainingLabel =
              upgradeModal.querySelector("#remainingLabel");
            const remainingTime = upgradeModal.querySelector("#remainingTime");
            const remainingUnit = upgradeModal.querySelector("#remainingUnit");

            if (packageType === "PT_SESSION") {
              // G√≥i PT: Hi·ªÉn th·ªã s·ªë bu·ªïi
              remainingLabel.textContent = "S·ªë bu·ªïi c√≤n l·∫°i:";
              remainingTime.textContent = remainingSessions;
              remainingUnit.textContent = "bu·ªïi";
              currentPackageData.remainingDays = null; // Kh√¥ng d√πng cho PT
              currentPackageData.totalDays = null;
            } else {
              // G√≥i th·ªùi gian: Hi·ªÉn th·ªã s·ªë ng√†y
              remainingLabel.textContent = "Th·ªùi gian c√≤n l·∫°i:";
              remainingUnit.textContent = "ng√†y";

              if (endDate && startDate) {
                const now = new Date();
                const remainingDays = Math.ceil(
                  (endDate - now) / (1000 * 60 * 60 * 24)
                );
                const totalDays = Math.ceil(
                  (endDate - startDate) / (1000 * 60 * 60 * 24)
                );
                remainingTime.textContent = remainingDays;
                currentPackageData.remainingDays = remainingDays;
                currentPackageData.totalDays = totalDays;
              } else {
                remainingTime.textContent = "N/A";
                currentPackageData.remainingDays = 0;
                currentPackageData.totalDays = 0;
              }
            }

            const form = upgradeModal.querySelector("#upgradeForm");
            form.action = baseUrl + "/upgrade/" + subId;

            // Reset select v√† ·∫©n price info
            upgradeModal.querySelector("#upgradeNewPackageSelect").value = "";
            upgradeModal.querySelector("#upgradePriceInfo").style.display =
              "none";
          });

          // T√≠nh to√°n khi ch·ªçn g√≥i m·ªõi
          const newPackageSelect = upgradeModal.querySelector(
            "#upgradeNewPackageSelect"
          );
          if (newPackageSelect) {
            newPackageSelect.addEventListener("change", async function () {
              const selectedOption = this.options[this.selectedIndex];
              if (!selectedOption.value) {
                upgradeModal.querySelector("#upgradePriceInfo").style.display =
                  "none";
                return;
              }

              const newPackageId = selectedOption.value;
              const originalPrice = parseFloat(
                selectedOption.getAttribute("data-price")
              );

              // Ki·ªÉm tra g√≥i m·ªõi ph·∫£i ƒë·∫Øt h∆°n
              if (originalPrice <= currentPackageData.price) {
                alert("G√≥i m·ªõi ph·∫£i c√≥ gi√° cao h∆°n g√≥i hi·ªán t·∫°i ƒë·ªÉ n√¢ng c·∫•p!");
                this.value = "";
                upgradeModal.querySelector("#upgradePriceInfo").style.display =
                  "none";
                return;
              }

              // T√≠nh gi√° tr·ªã ho√†n l·∫°i theo lo·∫°i g√≥i
              let refundValue = 0;

              if (currentPackageData.packageType === "PT_SESSION") {
                // G√≥i PT: T√≠nh theo bu·ªïi
                // L∆∞u √Ω: N·∫øu g√≥i ƒë√£ ƒë∆∞·ª£c gia h·∫°n, remainingSessions c√≥ th·ªÉ l·ªõn h∆°n totalSessions ban ƒë·∫ßu
                // Trong tr∆∞·ªùng h·ª£p ƒë√≥, ch·ªâ t√≠nh ho√†n l·∫°i t·ªëi ƒëa b·∫±ng gi√° g√≥i ƒë√£ thanh to√°n
                if (
                  currentPackageData.totalSessions > 0 &&
                  currentPackageData.remainingSessions > 0
                ) {
                  // N·∫øu s·ªë bu·ªïi c√≤n l·∫°i <= t·ªïng s·ªë bu·ªïi ban ƒë·∫ßu: t√≠nh b√¨nh th∆∞·ªùng
                  // N·∫øu s·ªë bu·ªïi c√≤n l·∫°i > t·ªïng s·ªë bu·ªïi ban ƒë·∫ßu (ƒë√£ gia h·∫°n): 
                  // ch·ªâ t√≠nh ho√†n l·∫°i cho s·ªë bu·ªïi ban ƒë·∫ßu
                  const sessionsToRefund = Math.min(
                    currentPackageData.remainingSessions,
                    currentPackageData.totalSessions
                  );
                  
                  const perSessionValue =
                    currentPackageData.price / currentPackageData.totalSessions;
                  refundValue = perSessionValue * sessionsToRefund;
                  
                  // ƒê·∫£m b·∫£o gi√° tr·ªã ho√†n l·∫°i kh√¥ng v∆∞·ª£t qu√° gi√° ƒë√£ thanh to√°n
                  refundValue = Math.min(refundValue, currentPackageData.price);
                }
              } else {
                // G√≥i th·ªùi gian: T√≠nh theo ng√†y
                if (
                  currentPackageData.totalDays > 0 &&
                  currentPackageData.remainingDays > 0
                ) {
                  const dailyValue =
                    currentPackageData.price / currentPackageData.totalDays;
                  refundValue = dailyValue * currentPackageData.remainingDays;
                }
              }

              // L·∫•y gi√° ƒë√£ gi·∫£m t·ª´ API (c√≥ promotion)
              let finalNewPrice = originalPrice;
              try {
                const memberId = /*[[${memberProfile.id}]]*/ null;
                const response = await fetch(
                  `/members/${memberId}/subscribe/preview?packageId=${newPackageId}`
                );
                if (response.ok) {
                  const data = await response.json();
                  if (data.finalPrice) {
                    finalNewPrice = parseFloat(data.finalPrice);
                  }
                }
              } catch (error) {
                console.warn("Kh√¥ng th·ªÉ l·∫•y gi√° ƒë√£ gi·∫£m, d√πng gi√° g·ªëc:", error);
              }

              // Ti·ªÅn ph·∫£i tr·∫£ = Gi√° ƒë√£ gi·∫£m - Gi√° tr·ªã ho√†n l·∫°i
              const finalPrice = Math.max(0, finalNewPrice - refundValue);

              // Hi·ªÉn th·ªã
              upgradeModal.querySelector("#newPackagePrice").textContent =
                finalNewPrice.toLocaleString("vi-VN");
              if (finalNewPrice !== originalPrice) {
                // Hi·ªÉn th·ªã gi√° g·ªëc b·ªã g·∫°ch ngang n·∫øu c√≥ gi·∫£m gi√°
                upgradeModal.querySelector("#newPackagePrice").innerHTML =
                  `<span class="text-decoration-line-through text-muted small">${originalPrice.toLocaleString(
                    "vi-VN"
                  )}</span> ` +
                  `<span class="text-danger fw-bold">${finalNewPrice.toLocaleString(
                    "vi-VN"
                  )}</span>`;
              }
              upgradeModal.querySelector("#refundValue").textContent =
                refundValue.toLocaleString("vi-VN");
              upgradeModal.querySelector("#finalUpgradePrice").textContent =
                finalPrice.toLocaleString("vi-VN");
              upgradeModal.querySelector("#upgradePriceInfo").style.display =
                "block";
            });
          }
        }

        const transferModal = document.getElementById("transferModal");
        if (transferModal) {
          transferModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const subId = button.getAttribute("data-bs-subid");
            const subName = button.getAttribute("data-bs-subname");
            const title = transferModal.querySelector("#transferPackageName");
            const form = transferModal.querySelector("#transferForm");
            title.textContent = subName;
            form.action = baseUrl + "/transfer/" + subId;
          });
        }

        // Set action cho form H·ªßy & Ho√†n ti·ªÅn
        const cancelModal = document.getElementById("cancelModal");
        if (cancelModal) {
          cancelModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const subId = button.getAttribute("data-subid");
            const subName = button.getAttribute("data-subname");
            const packageType = button.getAttribute("data-packagetype");
            const startDateStr = button.getAttribute("data-startdate");
            const endDateStr = button.getAttribute("data-enddate");
            const remainingSessions =
              parseInt(button.getAttribute("data-remainingsessions")) || 0;
            const totalSessions =
              parseInt(button.getAttribute("data-totalsessions")) || 0;
            const durationDays =
              parseInt(button.getAttribute("data-durationdays")) || 0;
            const price = parseFloat(button.getAttribute("data-price")) || 0;
            const form = document.getElementById("cancelForm");

            console.log("Opening cancel modal for subscription ID:", subId);
            console.log("Package type:", packageType);
            console.log("Subscription data:", {
              subName,
              packageType,
              startDateStr,
              endDateStr,
              remainingSessions,
              totalSessions,
              durationDays,
              price,
            });

            if (form) {
              form.action = "/members/subscription/cancel-refund/" + subId;
              console.log("Form action set to:", form.action);
            }

            // Hi·ªÉn th·ªã t√™n g√≥i trong modal
            const modalTitle = cancelModal.querySelector(".modal-title");
            if (modalTitle && subName) {
              modalTitle.textContent = "H·ªßy g√≥i & ho√†n ti·ªÅn: " + subName;
            }

            // T√≠nh to√°n v√† hi·ªÉn th·ªã s·ªë ti·ªÅn ho√†n
            const infoDiv = document.getElementById("cancelRefundInfo");
            let refundAmount = 0;
            let infoHtml = "";

            // X·ª≠ l√Ω theo lo·∫°i g√≥i
            if (
              packageType === "GYM_ACCESS" &&
              startDateStr &&
              endDateStr &&
              price > 0
            ) {
              // G√≥i GYM_ACCESS: T√≠nh theo ng√†y
              const now = new Date();
              const startDate = new Date(startDateStr);
              const endDate = new Date(endDateStr);

              const totalDays =
                durationDays > 0
                  ? durationDays
                  : Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
              const remainingDays = Math.max(
                0,
                Math.ceil((endDate - now) / (1000 * 60 * 60 * 24))
              );

              if (remainingDays > 0) {
                const dailyRate = price / totalDays;
                refundAmount = dailyRate * remainingDays;

                infoHtml = `
                <div class="alert alert-info">
                  <h6 class="mb-2">üìã Th√¥ng tin g√≥i t·∫≠p GYM:</h6>
                  <div class="d-flex justify-content-between mb-1">
                    <span>Gi√° g√≥i ƒë√£ thanh to√°n:</span>
                    <strong>${formatMoney(price)}</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-1">
                    <span>T·ªïng s·ªë ng√†y:</span>
                    <strong>${totalDays} ng√†y</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-1">
                    <span>S·ªë ng√†y c√≤n l·∫°i:</span>
                    <strong>${remainingDays} ng√†y</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-1 small text-muted">
                    <span>Gi√° m·ªói ng√†y:</span>
                    <span>${formatMoney(dailyRate)}</span>
                  </div>
                  <hr class="my-2" />
                  <div class="d-flex justify-content-between">
                    <span class="fw-bold text-success">üí∞ S·ªë ti·ªÅn ho√†n:</span>
                    <span class="fw-bold text-success fs-5">${formatMoney(
                      refundAmount
                    )}</span>
                  </div>
                </div>
              `;
              } else {
                infoHtml = `<div class="alert alert-warning">‚ùå G√≥i t·∫≠p ƒë√£ h·∫øt h·∫°n, kh√¥ng c√≥ ti·ªÅn ho√†n.</div>`;
              }
            } else if (
              (packageType === "PT_SESSION" || packageType === "PER_VISIT") &&
              totalSessions > 0 &&
              price > 0
            ) {
              // G√≥i PT ho·∫∑c PER_VISIT: T√≠nh theo bu·ªïi
              if (remainingSessions > 0) {
                const perSessionRate = price / totalSessions;
                refundAmount = perSessionRate * remainingSessions;

                infoHtml = `
                <div class="alert alert-info">
                  <h6 class="mb-2">üìã Th√¥ng tin g√≥i ${
                    packageType === "PT_SESSION" ? "PT" : "theo l∆∞·ª£t"
                  }:</h6>
                  <div class="d-flex justify-content-between mb-1">
                    <span>Gi√° g√≥i ƒë√£ thanh to√°n:</span>
                    <strong>${formatMoney(price)}</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-1">
                    <span>T·ªïng s·ªë bu·ªïi:</span>
                    <strong>${totalSessions} bu·ªïi</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-1">
                    <span>S·ªë bu·ªïi c√≤n l·∫°i:</span>
                    <strong class="text-primary">${remainingSessions} bu·ªïi</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-1 small text-muted">
                    <span>Gi√° m·ªói bu·ªïi:</span>
                    <span>${formatMoney(perSessionRate)}</span>
                  </div>
                  <hr class="my-2" />
                  <div class="d-flex justify-content-between">
                    <span class="fw-bold text-success">üí∞ S·ªë ti·ªÅn ho√†n:</span>
                    <span class="fw-bold text-success fs-5">${formatMoney(
                      refundAmount
                    )}</span>
                  </div>
                </div>
              `;
              } else {
                infoHtml = `<div class="alert alert-warning">‚ùå Kh√¥ng c√≤n bu·ªïi t·∫≠p, kh√¥ng c√≥ ti·ªÅn ho√†n.</div>`;
              }
            } else {
              // Tr∆∞·ªùng h·ª£p kh√¥ng x√°c ƒë·ªãnh
              infoHtml = `
              <div class="alert alert-warning">
                ‚ö†Ô∏è Kh√¥ng th·ªÉ t√≠nh to√°n s·ªë ti·ªÅn ho√†n t·ª± ƒë·ªông. Vui l√≤ng li√™n h·ªá qu·∫£n l√Ω.
              </div>
            `;
            }

            if (infoDiv) {
              infoDiv.innerHTML = infoHtml;
            }
          });
        }
      });
    </script>

    <!-- Modal H·ªßy & Ho√†n ti·ªÅn -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">H·ªßy g√≥i & ho√†n ti·ªÅn</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="cancelForm" method="post">
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <div class="modal-body">
              <input
                type="hidden"
                name="memberId"
                th:value="${memberProfile.id}"
              />

              <!-- Th√¥ng tin chi ti·∫øt v·ªÅ ti·ªÅn ho√†n -->
              <div id="cancelRefundInfo">
                <!-- S·∫Ω ƒë∆∞·ª£c JavaScript ƒëi·ªÅn v√†o -->
              </div>

              <div class="mb-3">
                <label class="form-label">Ph∆∞∆°ng th·ª©c ho√†n ti·ªÅn</label>
                <select class="form-select" name="paymentMethod" required>
                  <option value="CASH">üíµ Ti·ªÅn m·∫∑t</option>
                  <option value="VN_PAY">üí≥ VNPay (Online)</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">L√Ω do h·ªßy</label>
                <textarea
                  class="form-control"
                  name="reason"
                  rows="3"
                  placeholder="Nh·∫≠p l√Ω do h·ªßy..."
                ></textarea>
              </div>
              <div class="alert alert-warning">
                ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> Sau khi h·ªßy, g√≥i t·∫≠p s·∫Ω kh√¥ng th·ªÉ
                kh√¥i ph·ª•c. Vui l√≤ng x√°c nh·∫≠n k·ªπ tr∆∞·ªõc khi th·ª±c hi·ªán.
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
              <button type="submit" class="btn btn-danger">
                X√°c nh·∫≠n h·ªßy & ho√†n ti·ªÅn
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</html>
