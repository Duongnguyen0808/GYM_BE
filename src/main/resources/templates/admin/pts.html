<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <div th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">Qu·∫£n l√Ω PT</h2>
    </div>

    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

    <style>
      /* TrainerList - Accordion Container */
      .trainer-list {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* TrainerItem - Accordion Header */
      .trainer-item {
        background-color: #f1f5ff;
        border: 1px solid #e0e7ff;
        border-radius: 12px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
        cursor: pointer;
        overflow: hidden;
      }

      .trainer-item:hover {
        background-color: #e0e7ff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .trainer-item.active {
        background-color: #e0e7ff;
        border-color: #6366f1;
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
      }

      .trainer-header {
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .trainer-info {
        flex: 1;
      }

      .trainer-name {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 8px;
      }

      .trainer-meta {
        display: flex;
        gap: 16px;
        align-items: center;
        margin-top: 8px;
      }

      .trainer-phone {
        font-size: 14px;
        color: #64748b;
      }

      .trainer-badges {
        display: flex;
        gap: 8px;
      }

      .trainer-badge {
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
      }

      .trainer-badge.students {
        background-color: #10b981;
        color: white;
      }

      .trainer-badge.sessions {
        background-color: #3b82f6;
        color: white;
      }

      .trainer-toggle {
        font-size: 24px;
        color: #6366f1;
        transition: transform 0.3s ease;
      }

      .trainer-item.active .trainer-toggle {
        transform: rotate(180deg);
      }

      /* TrainerDetail - Accordion Content */
      .trainer-detail {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
        background-color: #ffffff;
      }

      .trainer-item.active .trainer-detail {
        max-height: 5000px;
      }

      .trainer-detail-content {
        padding: 24px;
        border-top: 1px solid #e0e7ff;
      }

      /* TrainerStats */
      .trainer-stats {
        margin-bottom: 24px;
      }

      .stats-title {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .stat-card {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.2s ease;
      }

      .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .stat-value.primary {
        color: #6366f1;
      }

      .stat-value.success {
        color: #10b981;
      }

      .stat-value.info {
        color: #3b82f6;
      }

      .stat-value.warning {
        color: #f59e0b;
      }

      .stat-label {
        font-size: 14px;
        color: #64748b;
        font-weight: 500;
      }

      /* TrainerRevenue */
      .trainer-revenue {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .revenue-card {
        background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        border: 1px solid #dcfce7;
        border-radius: 12px;
        padding: 20px;
      }

      .revenue-title {
        font-size: 14px;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .revenue-item {
        margin-bottom: 12px;
      }

      .revenue-item:last-child {
        margin-bottom: 0;
      }

      .revenue-label {
        font-size: 13px;
        color: #64748b;
        margin-bottom: 4px;
      }

      .revenue-amount {
        font-size: 20px;
        font-weight: 700;
      }

      .revenue-amount.total {
        color: #10b981;
      }

      .revenue-amount.month {
        color: #3b82f6;
      }

      /* TrainerStudentTable */
      .student-table-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
      }

      .student-table-header {
        background-color: #f8fafc;
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
      }

      .student-table-header h5 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
      }

      .table {
        margin-bottom: 0;
      }

      .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
      }

      .loading-spinner.active {
        display: block;
      }

      .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
      }
    </style>

    <!-- TrainerList Component -->
    <div class="trainer-list">
      <div th:if="${ptsWithStats == null or #lists.isEmpty(ptsWithStats)}" 
           class="alert alert-info text-center py-5">
        <i class="bi bi-info-circle me-2"></i>
        Ch∆∞a c√≥ hu·∫•n luy·ªán vi√™n n√†o
      </div>

      <!-- TrainerItem Components -->
      <div th:each="ptInfo : ${ptsWithStats}" 
           class="trainer-item" 
           th:attr="data-pt-id=${ptInfo.pt.id}">
        
        <!-- TrainerItem Header -->
        <div class="trainer-header" onclick="toggleTrainer(this)">
          <div class="trainer-info">
            <div class="trainer-name" th:text="${ptInfo.pt.fullName}">PT Name</div>
            <div class="trainer-meta">
              <div class="trainer-phone" th:text="${'üìû ' + ptInfo.pt.phoneNumber}">Phone</div>
              <div class="trainer-badges">
                <span class="trainer-badge students" 
                      th:text="${ptInfo.activeStudents + ' h·ªçc vi√™n'}">0 h·ªçc vi√™n</span>
                <span class="trainer-badge sessions" 
                      th:text="${ptInfo.totalSessions + ' bu·ªïi'}">0 bu·ªïi</span>
              </div>
            </div>
          </div>
          <div class="trainer-toggle">
            <i class="bi bi-chevron-down"></i>
          </div>
        </div>

        <!-- TrainerDetail Component -->
        <div class="trainer-detail">
          <div class="trainer-detail-content">
            <!-- Loading Spinner -->
            <div class="loading-spinner" th:attr="id=${'loading-' + ptInfo.pt.id}">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-muted">ƒêang t·∫£i th√¥ng tin...</p>
            </div>

            <!-- TrainerDetail Content (s·∫Ω ƒë∆∞·ª£c load ƒë·ªông) -->
            <div class="trainer-content" th:attr="id=${'content-' + ptInfo.pt.id}" style="display: none;">
              <!-- TrainerStats Component -->
              <div class="trainer-stats">
                <div class="stats-title">
                  <i class="bi bi-bar-chart-fill text-primary"></i>
                  Th·ªëng k√™
                </div>
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value primary" data-stat="activeStudents">0</div>
                    <div class="stat-label">H·ªçc vi√™n ƒëang t·∫≠p</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value success" data-stat="totalStudents">0</div>
                    <div class="stat-label">T·ªïng h·ªçc vi√™n</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value info" data-stat="totalSessions">0</div>
                    <div class="stat-label">T·ªïng bu·ªïi t·∫≠p</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value warning" data-stat="sessionsThisMonth">0</div>
                    <div class="stat-label">Bu·ªïi t·∫≠p th√°ng n√†y</div>
                  </div>
                </div>
              </div>

              <!-- TrainerRevenue Component -->
              <div class="trainer-revenue">
                <div class="revenue-card">
                  <div class="revenue-title">
                    <i class="bi bi-wallet2 text-success"></i>
                    Doanh thu
                  </div>
                  <div class="revenue-item">
                    <div class="revenue-label">T·ªïng doanh thu</div>
                    <div class="revenue-amount total" data-revenue="totalRevenue">0 VNƒê</div>
                  </div>
                  <div class="revenue-item">
                    <div class="revenue-label">Doanh thu th√°ng n√†y</div>
                    <div class="revenue-amount month" data-revenue="revenueThisMonth">0 VNƒê</div>
                  </div>
                </div>
                <div class="revenue-card">
                  <div class="revenue-title">
                    <i class="bi bi-calendar-check text-info"></i>
                    Bu·ªïi t·∫≠p
                  </div>
                  <div class="revenue-item">
                    <div class="revenue-label">T·ªïng s·ªë bu·ªïi c√≤n l·∫°i</div>
                    <div class="revenue-amount info" data-revenue="totalRemainingSessions">0</div>
                  </div>
                  <div class="revenue-item">
                    <div class="revenue-label">Trung b√¨nh bu·ªïi/h·ªçc vi√™n</div>
                    <div class="revenue-amount info" data-revenue="avgSessions">0</div>
                  </div>
                </div>
              </div>

              <!-- TrainerStudentTable Component -->
              <div class="student-table-card">
                <div class="student-table-header">
                  <h5>Danh s√°ch h·ªçc vi√™n ƒëang t·∫≠p</h5>
                </div>
                <div class="student-table-container" data-table="students">
                  <!-- Table s·∫Ω ƒë∆∞·ª£c render ƒë·ªông -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      let currentOpenItem = null;

      function toggleTrainer(headerElement) {
        const trainerItem = headerElement.closest('.trainer-item');
        const ptId = trainerItem.getAttribute('data-pt-id');
        const detail = trainerItem.querySelector('.trainer-detail');
        const isActive = trainerItem.classList.contains('active');

        // ƒê√≥ng item hi·ªán t·∫°i n·∫øu ƒëang m·ªü item kh√°c
        if (currentOpenItem && currentOpenItem !== trainerItem) {
          closeTrainer(currentOpenItem);
        }

        if (isActive) {
          // ƒê√≥ng item hi·ªán t·∫°i
          closeTrainer(trainerItem);
          currentOpenItem = null;
        } else {
          // M·ªü item m·ªõi
          openTrainer(trainerItem, ptId);
          currentOpenItem = trainerItem;
        }
      }

      function closeTrainer(trainerItem) {
        trainerItem.classList.remove('active');
      }

      function openTrainer(trainerItem, ptId) {
        trainerItem.classList.add('active');
        
        const loadingEl = document.getElementById('loading-' + ptId);
        const contentEl = document.getElementById('content-' + ptId);
        const tableContainer = trainerItem.querySelector('.student-table-container');

        // Ki·ªÉm tra xem ƒë√£ load data ch∆∞a
        if (contentEl && contentEl.dataset.loaded === 'true') {
          // ƒê√£ load r·ªìi, ch·ªâ hi·ªÉn th·ªã
          if (loadingEl) loadingEl.classList.remove('active');
          if (contentEl) contentEl.style.display = 'block';
          return;
        }

        // Hi·ªÉn th·ªã loading
        if (loadingEl) loadingEl.classList.add('active');
        if (contentEl) contentEl.style.display = 'none';

        // G·ªçi API ƒë·ªÉ l·∫•y th·ªëng k√™
        fetch(`/admin/pts/${ptId}/stats`)
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(data => {
            // ·∫®n loading, hi·ªÉn th·ªã content
            if (loadingEl) loadingEl.classList.remove('active');
            if (contentEl) {
              contentEl.style.display = 'block';
              contentEl.dataset.loaded = 'true';
            }

            // Render th·ªëng k√™
            renderStats(contentEl, data.stats);
            
            // Render doanh thu
            renderRevenue(contentEl, data.stats);
            
            // Render b·∫£ng h·ªçc vi√™n
            renderStudentTable(tableContainer, data.stats.activeStudentsList);
          })
          .catch(error => {
            console.error('Error loading PT stats:', error);
            if (loadingEl) {
              loadingEl.innerHTML = '<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i.</p>';
            }
          });
      }

      function renderStats(container, stats) {
        const statsToRender = {
          'activeStudents': stats.activeStudents || 0,
          'totalStudents': stats.totalStudents || 0,
          'totalSessions': stats.totalSessions || 0,
          'sessionsThisMonth': stats.sessionsThisMonth || 0
        };

        Object.keys(statsToRender).forEach(key => {
          const el = container.querySelector(`[data-stat="${key}"]`);
          if (el) {
            el.textContent = statsToRender[key];
          }
        });
      }

      function renderRevenue(container, stats) {
        // Format s·ªë ti·ªÅn
        function formatMoney(amount) {
          if (!amount) return '0 VNƒê';
          return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
        }

        // T·ªïng doanh thu
        const totalRevenueEl = container.querySelector('[data-revenue="totalRevenue"]');
        if (totalRevenueEl) {
          totalRevenueEl.textContent = formatMoney(stats.totalRevenue);
        }

        // Doanh thu th√°ng n√†y
        const revenueMonthEl = container.querySelector('[data-revenue="revenueThisMonth"]');
        if (revenueMonthEl) {
          revenueMonthEl.textContent = formatMoney(stats.revenueThisMonth);
        }

        // T·ªïng bu·ªïi c√≤n l·∫°i
        const totalRemainingEl = container.querySelector('[data-revenue="totalRemainingSessions"]');
        if (totalRemainingEl) {
          totalRemainingEl.textContent = stats.totalRemainingSessions || 0;
        }

        // Trung b√¨nh bu·ªïi/h·ªçc vi√™n
        const avgSessionsEl = container.querySelector('[data-revenue="avgSessions"]');
        if (avgSessionsEl) {
          const avg = stats.activeStudents > 0 
            ? (stats.totalSessions / stats.activeStudents).toFixed(1) 
            : '0';
          avgSessionsEl.textContent = avg;
        }
      }

      function renderStudentTable(container, studentsList) {
        if (!studentsList || studentsList.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info m-3 text-center">
              <i class="bi bi-info-circle me-2"></i>
              PT n√†y ch∆∞a c√≥ h·ªçc vi√™n n√†o ƒëang t·∫≠p.
            </div>
          `;
          return;
        }

        // Format date
        function formatDate(dateStr) {
          if (!dateStr) return '-';
          const date = new Date(dateStr);
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        }

        let tableHTML = `
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">H·ªçc vi√™n</th>
                  <th scope="col">G√≥i t·∫≠p</th>
                  <th scope="col" style="width: 120px;">Th·ªùi h·∫°n</th>
                  <th scope="col" style="width: 150px;">Th·ªùi gian t·∫≠p</th>
                  <th scope="col" style="width: 120px;">Bu·ªïi c√≤n l·∫°i</th>
                  <th scope="col" style="width: 130px;">Ng√†y b·∫Øt ƒë·∫ßu</th>
                  <th scope="col" style="width: 130px;">Ng√†y k·∫øt th√∫c</th>
                  <th scope="col" class="text-end" style="width: 100px;">H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody>
        `;

        studentsList.forEach(student => {
          const timeSlotBadge = student.timeSlotDisplay && student.timeSlotDisplay !== '-'
            ? `<span class="badge bg-info text-white">${student.timeSlotDisplay}</span>`
            : `<span class="text-muted small">Ch∆∞a ch·ªçn</span>`;

          const remainingSessions = student.remainingSessions != null
            ? `<span class="badge ${student.remainingSessions <= 3 ? 'bg-danger' : 'bg-success'}">${student.remainingSessions} bu·ªïi</span>`
            : `<span class="text-muted small">-</span>`;

          const durationBadge = student.durationDisplay && student.durationDisplay !== '-'
            ? `<span class="badge bg-warning text-dark">${student.durationDisplay}</span>`
            : `<span class="text-muted small">-</span>`;

          tableHTML += `
            <tr>
              <td>
                <div>
                  <div class="fw-bold mb-1">${student.memberName}</div>
                  <div class="small text-muted">üìû ${student.phoneNumber}</div>
                </div>
              </td>
              <td>
                <span class="badge bg-primary">${student.packageName}</span>
              </td>
              <td>
                ${durationBadge}
              </td>
              <td>${timeSlotBadge}</td>
              <td>${remainingSessions}</td>
              <td>
                <span class="small">${formatDate(student.startDate)}</span>
              </td>
              <td>
                <span class="small">${formatDate(student.endDate)}</span>
              </td>
              <td class="text-end">
                <a href="/members/detail/${student.memberId}" 
                   class="btn btn-sm btn-outline-primary" 
                   title="Xem chi ti·∫øt">
                  <i class="bi bi-eye"></i>
                </a>
              </td>
            </tr>
          `;
        });

        tableHTML += `
              </tbody>
            </table>
          </div>
        `;

        container.innerHTML = tableHTML;
      }
    </script>
  </div>
</html>
