<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <div th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="mb-0">B√°o c√°o Doanh thu</h2>
      <form
        th:action="@{/admin/reports/sales}"
        method="get"
        class="d-flex align-items-end gap-2"
      >
        <div>
          <label class="form-label">T·ª´ ng√†y</label>
          <input
            type="date"
            class="form-control"
            name="start"
            th:value="${start}"
          />
        </div>
        <div>
          <label class="form-label">ƒê·∫øn ng√†y</label>
          <input
            type="date"
            class="form-control"
            name="end"
            th:value="${end}"
          />
        </div>
        <div>
          <label class="form-label">Lo·∫°i</label>
          <select class="form-select" name="type">
            <option value="ALL" th:selected="${type == null or type == 'ALL'}">
              T·∫•t c·∫£
            </option>
            <option value="POS" th:selected="${type == 'POS'}">
              B√°n l·∫ª (POS)
            </option>
            <option
              value="SUBSCRIPTION"
              th:selected="${type == 'SUBSCRIPTION'}"
            >
              G√≥i t·∫≠p
            </option>
          </select>
        </div>
        <div>
          <label class="form-label">H√¨nh th·ª©c</label>
          <select class="form-select" name="method">
            <option value="" th:selected="${method == null}">T·∫•t c·∫£</option>
            <option value="CASH" th:selected="${method?.name() == 'CASH'}">
              üíµ Ti·ªÅn m·∫∑t
            </option>
            <option value="VN_PAY" th:selected="${method?.name() == 'VN_PAY'}">
              üí≥ VNPay
            </option>
            <option
              value="BANK_TRANSFER"
              th:selected="${method?.name() == 'BANK_TRANSFER'}"
            >
              üè¶ Chuy·ªÉn kho·∫£n (Admin)
            </option>
          </select>
        </div>
        <div>
          <label class="form-label">Tr·∫°ng th√°i</label>
          <select class="form-select" name="status">
            <option value="" th:selected="${status == null}">T·∫•t c·∫£</option>
            <option
              value="COMPLETED"
              th:selected="${status?.name() == 'COMPLETED'}"
            >
              ƒê√£ thanh to√°n
            </option>
            <option
              value="PENDING"
              th:selected="${status?.name() == 'PENDING'}"
            >
              Ch∆∞a thanh to√°n
            </option>
          </select>
        </div>
        <button type="submit" class="btn btn-outline-primary">L·ªçc</button>
      </form>
    </div>

    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h5 class="text-muted mb-2">T·ªïng doanh thu (Ho√†n th√†nh)</h5>
            <h2 class="text-success mb-0">
              <span
                th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"
              ></span>
            </h2>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h5 class="text-muted mb-2">T·ªïng giao d·ªãch</h5>
            <h2 class="text-primary mb-0" th:text="${#lists.size(reportData)}">
              0
            </h2>
          </div>
        </div>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì th·ªëng k√™ -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Bi·ªÉu ƒë·ªì Doanh thu</h5>
      </div>
      <div class="card-body">
        <canvas id="revenueChart" height="80"></canvas>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">Th·ªùi gian</th>
              <th scope="col">Lo·∫°i giao d·ªãch</th>
              <th scope="col">M√¥ t·∫£</th>
              <th scope="col">Ng∆∞·ªùi mua</th>
              <th scope="col">Nh√¢n vi√™n</th>
              <th scope="col">H√¨nh th·ª©c</th>
              <th scope="col">Tr·∫°ng th√°i</th>
              <th scope="col" class="text-end">S·ªë ti·ªÅn (VNƒê)</th>
              <th scope="col" class="text-end">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="tx : ${reportData}">
              <td
                th:text="${#temporals.format(tx.transactionDate.atZoneSameInstant(T(java.time.ZoneId).of('Asia/Ho_Chi_Minh')), 'dd/MM/yyyy HH:mm')}"
              ></td>
              <td th:text="${tx.transactionType}">G√≥i t·∫≠p</td>
              <td th:text="${tx.description}">G√≥i 1 th√°ng</td>
              <td th:text="${tx.buyerName}">Kh√°ch v√£ng lai</td>
              <td th:text="${tx.createdByStaffName}">Nh√¢n vi√™n A</td>
              <td>
                <span
                  th:text="${tx.paymentMethod.name() == 'CASH' ? 'Ti·ªÅn m·∫∑t' : 
                                (tx.paymentMethod.name() == 'VN_PAY' ? 'VNPay' : 
                                (tx.paymentMethod.name() == 'BANK_TRANSFER' ? 'Chuy·ªÉn kho·∫£n' : tx.paymentMethod))}"
                >
                  CASH
                </span>
              </td>

              <td>
                <span
                  th:text="${tx.amount < 0 ? 'ƒê√£ ho√†n ti·ªÅn' : (tx.status.name() == 'COMPLETED' ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n')}"
                  th:classappend="${tx.amount < 0 ? 'badge bg-danger' : (tx.status.name() == 'COMPLETED' ? 'badge bg-success' : 'badge bg-warning text-dark')}"
                >
                </span>
              </td>

              <td
                class="text-end fw-bold"
                th:classappend="${tx.amount < 0 ? 'text-danger' : ''}"
                th:text="${#numbers.formatDecimal(tx.amount, 0, 'COMMA', 0, 'POINT')}"
              ></td>
              <td class="text-end">
                <a
                  th:if="${tx.status.name() == 'COMPLETED'}"
                  th:href="@{/admin/receipts/transaction/{id}(id=${tx.id})}"
                  class="btn btn-sm btn-outline-secondary"
                  >Xu·∫•t h√≥a ƒë∆°n</a
                >
                <span
                  th:if="${tx.status.name() != 'COMPLETED'}"
                  class="text-muted small"
                  >-</span
                >
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
      const reportData = /*[[${reportData}]]*/ [];

      // Nh√≥m d·ªØ li·ªáu theo ng√†y
      const dailyRevenue = {};
      reportData.forEach((tx) => {
        if (tx.status === "COMPLETED") {
          const date = new Date(tx.transactionDate);
          const dateStr = date.toLocaleDateString("vi-VN");

          if (!dailyRevenue[dateStr]) {
            dailyRevenue[dateStr] = 0;
          }
          dailyRevenue[dateStr] += tx.amount;
        }
      });

      // S·∫Øp x·∫øp theo ng√†y
      const sortedDates = Object.keys(dailyRevenue).sort((a, b) => {
        const [dayA, monthA, yearA] = a.split("/");
        const [dayB, monthB, yearB] = b.split("/");
        return (
          new Date(yearA, monthA - 1, dayA) - new Date(yearB, monthB - 1, dayB)
        );
      });

      const labels = sortedDates;
      const data = sortedDates.map((date) => dailyRevenue[date]);

      // T·∫°o bi·ªÉu ƒë·ªì
      const ctx = document.getElementById("revenueChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Doanh thu (VNƒê)",
              data: data,
              backgroundColor: "rgba(54, 162, 235, 0.5)",
              borderColor: "rgba(54, 162, 235, 1)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: "top",
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || "";
                  if (label) {
                    label += ": ";
                  }
                  label +=
                    new Intl.NumberFormat("vi-VN").format(context.parsed.y) +
                    " VNƒê";
                  return label;
                },
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value) {
                  return new Intl.NumberFormat("vi-VN").format(value);
                },
              },
            },
          },
        },
      });
      /*]]>*/
    </script>
  </div>
</html>
