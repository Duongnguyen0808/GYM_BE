<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="content">

    <h2 class="mb-4" th:text="${productId != null} ? 'Cập nhật Sản phẩm' : 'Tạo Sản phẩm mới'"></h2>

    <div class="card shadow-sm">
        <div class="card-body">

            <form th:action="${productId != null} ? @{/admin/products/edit/{id}(id=${productId})} : @{/admin/products/create}"
                  th:object="${productRequest}"
                  method="post" enctype="multipart/form-data">

                <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
                    <p th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                </div>

                <div class="mb-3">
                    <label for="name" class="form-label">Tên Sản phẩm</label>
                    <input type="text" th:field="*{name}" id="name" class="form-control"
                           th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''">
                    <div th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="invalid-feedback"></div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="price" class="form-label">Giá (VNĐ)</label>
                            <input type="number" th:field="*{price}" id="price" class="form-control"
                                   th:classappend="${#fields.hasErrors('price')} ? 'is-invalid' : ''">
                            <div th:if="${#fields.hasErrors('price')}" th:errors="*{price}" class="invalid-feedback"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="stockQuantity" class="form-label">Số lượng Tồn kho</label>
                            <input type="number" th:field="*{stockQuantity}" id="stockQuantity" class="form-control"
                                   th:classappend="${#fields.hasErrors('stockQuantity')} ? 'is-invalid' : ''">
                            <div th:if="${#fields.hasErrors('stockQuantity')}" th:errors="*{stockQuantity}" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Hình ảnh Sản phẩm</label>
                    <div class="d-flex align-items-start gap-3">
                        <div style="width: 140px; height: 140px; border: 1px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f8f9fa; position: relative;">
                            <img id="productImagePreview"
                                 th:src="${productRequest.imageUrl != null} ? ${productRequest.imageUrl} : ''"
                                 alt="Preview"
                                 style="max-width: 100%; max-height: 100%; object-fit: cover; display: none;">
                            <span id="productImagePlaceholder" class="text-muted" style="font-size: 0.9rem;">Chưa có ảnh</span>
                        </div>
                        <div class="flex-grow-1">
                            <input id="productImageInput" type="file" name="imageFile" accept="image/*" class="form-control">
                            <small class="text-muted d-block mt-2">Hỗ trợ jpg, png, webp. Ảnh sẽ được tải lên Cloudinary.</small>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span th:if="${productId != null}">Lưu thay đổi</span>
                    <span th:if="${productId == null}">Tạo sản phẩm</span>
                </button>
                <a th:href="@{/admin/products}" class="btn btn-secondary">Hủy</a>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
    (function(){
        const input = document.getElementById('productImageInput');
        const img = document.getElementById('productImagePreview');
        const ph = document.getElementById('productImagePlaceholder');
        let currentUrl = null;
        if (input) {
            input.addEventListener('change', function(){
                if (this.files && this.files[0]) {
                    if (currentUrl) { try { URL.revokeObjectURL(currentUrl); } catch(e) {} }
                    currentUrl = URL.createObjectURL(this.files[0]);
                    img.src = currentUrl;
                    img.style.display = 'block';
                    if (ph) ph.style.display = 'none';
                }
            });
        }
        if (img && img.getAttribute('src') && img.getAttribute('src').length > 0) {
            img.style.display='block';
            if (ph) ph.style.display='none';
        }
    })();
    </script>

</div>

</html>